<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹ ê³  ë‚´ìš© ìë™í™”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f9f9f9;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 95%;
      max-width: 480px;
      background: #fff;
      padding: 15px 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      box-sizing: border-box;
      position: relative;
    }
    h2 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
    .select-box { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; user-select: none; }
    .select-box label {
      cursor: pointer; padding: 8px 16px; border: 2px solid #4caf50;
      border-radius: 25px; font-weight: 600; color: #4caf50;
      transition: background-color 0.2s, color 0.2s;
    }
    .select-box input[type="radio"] { display: none; }
    .select-box input[type="radio"]:checked + label { background-color: #4caf50; color: white; }
    #searchBox, #memoBox, #phoneBox {
      width: 100%; padding: 12px 14px; font-size: 16px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-weight: 500;
    }
    textarea { resize: none; min-height: 60px; }
    .suggestions {
      border: 1px solid #ccc; border-radius: 8px; max-height: 180px; overflow-y: auto; margin-bottom: 10px;
      background: #fff; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1); font-size: 15px;
    }
    .suggestion-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #eee; }
    .suggestion-item:hover { background-color: #e6f7ff; }
    #resultBox {
      margin-top: 15px; padding: 15px; background: #f5f5f5; border: 2px solid #4caf50;
      border-radius: 8px; font-weight: 600; white-space: pre-wrap; font-size: 1rem;
    }
    #resultBox.loading { color: #d32f2f; font-weight: 900; }
    #fullAddressWrapper {
      margin-top: 12px; padding: 12px 14px; border: 1.5px dashed #ccc; background-color: #fdfdfd;
      border-radius: 8px; font-size: 0.95rem; color: #444; white-space: pre-wrap;
      display: flex; justify-content: space-between; align-items: center; gap: 8px;
    }
    #addressText { flex: 1; }
    .naver-icon { width: 32px; height: 32px; cursor: pointer; flex-shrink: 0; }
    .btn-group { display: flex; gap: 10px; margin-top: 18px; }
    button { flex: 1; padding: 15px; background: #4caf50; color: white; font-size: 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    button.refresh { background: #888; }
    #copyNotice { margin-top: 8px; color: #4caf50; font-weight: 700; font-size: 0.95rem; text-align: center; opacity: 0; transition: opacity 0.3s ease; }
    #copyNotice.visible { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ” ì‹ ê³  ë‚´ìš© ìë™í™”</h2>

    <div class="select-box" id="selectBox">
      <input type="radio" name="signal" id="stop" value="ì •ì§€" /><label for="stop">ì •ì§€</label>
      <input type="radio" name="signal" id="complain" value="ë¯¼ì›" /><label for="complain">ë¯¼ì›</label>
      <input type="radio" name="signal" id="trapped" value="ìŠ¹ê°ê°‡í˜" /><label for="trapped">ìŠ¹ê°ê°‡í˜</label>
    </div>

    <input type="text" id="searchBox" placeholder="í˜„ì¥ëª…Â·ìŠ¹ê°•ê¸°ë²ˆí˜¸Â·ì£¼ì†Œ ì¼ë¶€ ì…ë ¥" autocomplete="off" />
    <div id="suggestions" class="suggestions"></div>

    <label for="memoBox">ğŸ“Œ ì‹ ê³ ë‚´ìš©</label>
    <textarea id="memoBox" placeholder="ì‹ ê³ ë‚´ìš© ê¸°ì…"></textarea>

    <label for="phoneBox">ğŸ“ ì—°ë½ì²˜</label>
    <input type="text" id="phoneBox" placeholder="ì‹ ê³ ì ì—°ë½ì²˜ ê¸°ì…" />

    <div id="resultBox" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div id="fullAddressWrapper">
      <span id="addressText"></span>
      <img id="naverIcon" class="naver-icon" 
           src="https://www.darun.io/_next/image?url=https%3A%2F%2Fres.cloudinary.com%2Fdqddtkvmb%2Fimage%2Fupload%2Fv1715433300%2Fimages%2Flogos%2Fnavermap.png&w=256&q=75" 
           alt="ë„¤ì´ë²„ì§€ë„" title="ë„¤ì´ë²„ ì§€ë„ì—ì„œ ì—´ê¸°" />
    </div>

    <div class="btn-group">
      <button type="button" class="refresh" onclick="resetAll(event)">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button type="button" onclick="copyResult()">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
    </div>

    <div id="copyNotice"></div>
  </div>

  <script>
    // âœ… data/sites.tsv ì‚¬ìš© (RAW ë§í¬)
    const RAW_TSV_URL = "https://raw.githubusercontent.com/minpd77/DMEL/main/data/sites.tsv";

    let siteData = [];
    let selectedSite = null;

    const $ = (id) => document.getElementById(id);
    const searchBox = $("searchBox");
    const memoBox = $("memoBox");
    const phoneBox = $("phoneBox");
    const suggestionsDiv = $("suggestions");
    const resultBox = $("resultBox");
    const addressText = $("addressText");
    const selectBox = $("selectBox");
    const copyNotice = $("copyNotice");
    const naverIcon = $("naverIcon");

    // ====== ìœ í‹¸ ======
    function normalizeElevatorNumber(input) {
      const digits = String(input || "").replace(/\D/g, "");
      if (!digits) return "";
      return digits.padStart(7, "0").replace(/^(\d{4})(\d{3})$/, "$1-$2");
    }
    function normalize(str) { return (str || "").toLowerCase().replace(/[\s-]+/g, ""); }
    function removeProvince(addr) {
      const provinces = ["ì„œìš¸íŠ¹ë³„ì‹œ","ì„œìš¸ì‹œ","ê²½ê¸°ë„","ì¸ì²œê´‘ì—­ì‹œ","ë¶€ì‚°ê´‘ì—­ì‹œ","ëŒ€êµ¬ê´‘ì—­ì‹œ","ê´‘ì£¼ê´‘ì—­ì‹œ","ëŒ€ì „ê´‘ì—­ì‹œ","ìš¸ì‚°ê´‘ì—­ì‹œ","ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ","ê°•ì›ë„","ì¶©ì²­ë¶ë„","ì¶©ì²­ë‚¨ë„","ì „ë¼ë¶ë„","ì „ë¼ë‚¨ë„","ê²½ìƒë¶ë„","ê²½ìƒë‚¨ë„","ì œì£¼íŠ¹ë³„ìì¹˜ë„"];
      for (const prov of provinces) { if ((addr||"").startsWith(prov)) return addr.slice(prov.length); }
      return addr||"";
    }
    function normalizeSearchTerm(term) { return normalize(removeProvince(term)); }
    function normalizeAddress(addr)  { return normalize(removeProvince(addr)); }
    function shortenAddress(addr) {
      const a = addr || "";
      const gu = a.match(/[ê°€-í£]{1,6}êµ¬/); if (gu) return gu[0];
      const si = a.match(/[ê°€-í£]{1,6}ì‹œ/); if (si) return si[0];
      return a;
    }
    const normKey = (s) => String(s||"").toLowerCase().replace(/\s+/g,"").replace(/[._-]/g,"");

    // ====== TSV ë¡œë”© + ìœ ì—° ë§¤í•‘ ======
    async function loadSiteData() {
      const url = RAW_TSV_URL + (RAW_TSV_URL.includes("?") ? "&" : "?") + "_ts=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("TSV ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: HTTP " + res.status);
      const text = await res.text();

      const rows = text.trim().split(/\r?\n/).map(r => r.split("\t"));
      if (!rows.length) return [];

      // í—¤ë” ê°€ê³µ
      const rawHeader = rows[0].map(h => (h||"").trim());
      const header = rawHeader.map(normKey);

      // í›„ë³´: (ì™¼ìª½ë¶€í„° ìš°ì„ )
      const mapCandidates = {
        siteName:     ["í˜„ì¥ëª…","í˜„ì¥ì´ë¦„","sitename","site","name","ì¥ì†Œ"],
        zone:         ["êµ¬ì—­","íŒ€","team","zone"],
        address:      ["ì£¼ì†Œ","ë„ë¡œëª…ì£¼ì†Œ","address","roadaddress"],
        jibunAddress: ["ì§€ë²ˆì£¼ì†Œ","ì§€ë²ˆ","jibun","lotaddress"],
        elevator:     ["ìŠ¹ê°•ê¸°ë²ˆí˜¸","ê³ ìœ ë²ˆí˜¸","elevator","elevatorno","elvno","no_plaq","plaq","eleno"],
        extra:        ["ê¸°ì¢…","íŠ¹ì´ì‚¬í•­","ë¹„ê³ ","ëª¨ë¸","model","etc","ì¶”ê°€ì •ë³´","ë©”ëª¨"]
      };

      const indexOfAny = (cands) => {
        for (const c of cands) {
          const i = header.indexOf(c);
          if (i !== -1) return i;
        }
        return -1;
      };

      const idx = {
        siteName: indexOfAny(mapCandidates.siteName),
        zone: indexOfAny(mapCandidates.zone),
        address: indexOfAny(mapCandidates.address),
        jibunAddress: indexOfAny(mapCandidates.jibunAddress),
        elevator: indexOfAny(mapCandidates.elevator),
        extra: indexOfAny(mapCandidates.extra)
      };

      return rows.slice(1).map(r => ({
        siteName: (idx.siteName>=0 ? (r[idx.siteName]||"").trim() : ""),
        zone: (idx.zone>=0 ? (r[idx.zone]||"").trim() : ""),
        address: (idx.address>=0 ? (r[idx.address]||"").trim() : ""),
        jibunAddress: (idx.jibunAddress>=0 ? (r[idx.jibunAddress]||"").trim() : ""),
        elevator: normalizeElevatorNumber(idx.elevator>=0 ? (r[idx.elevator]||"") : ""),
        extra: (idx.extra>=0 ? (r[idx.extra]||"").trim() : "")
      })).filter(x => x.siteName || x.address || x.elevator);
    }

    // ====== ì´ˆê¸° ë¡œë”© ======
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        resultBox.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        siteData = await loadSiteData();
        resultBox.textContent = siteData.length ? "í˜„ì¥ëª…Â·ìŠ¹ê°•ê¸°ë²ˆí˜¸Â·ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”." : "âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      } catch (e) {
        console.error(e);
        resultBox.textContent = "âŒ TSV ë¡œë”© ì˜¤ë¥˜: " + String(e.message||e);
      } finally {
        resultBox.classList.remove("loading");
      }
    });

    // ====== ê²€ìƒ‰/ìë™ì™„ì„± ======
    searchBox.addEventListener("input", function () {
      const term = normalizeSearchTerm(this.value);
      suggestionsDiv.innerHTML = "";
      selectedSite = null;

      if (term.length < 2) { updateResult(); return; }

      siteData
        .filter(item =>
          normalize(item.siteName).includes(term) ||
          normalizeAddress(item.address).includes(term) ||
          normalizeAddress(item.jibunAddress).includes(term) ||
          normalize(item.elevator).includes(term)
        )
        .slice(0, 20)
        .forEach(item => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = `${item.siteName} | ${item.elevator} | ${shortenAddress(item.address)}`;
          div.onclick = () => { selectedSite = item; searchBox.value = item.siteName; suggestionsDiv.innerHTML = ""; updateResult(); };
          suggestionsDiv.appendChild(div);
        });

      updateResult();
    });

    memoBox.addEventListener("input", updateResult);
    phoneBox.addEventListener("input", updateResult);

    // ë¼ë””ì˜¤ ì¬í† ê¸€ í—ˆìš©
    selectBox.addEventListener("click", (e) => {
      if (e.target.tagName === "INPUT" && e.target.type === "radio") {
        if (e.target.wasChecked) { e.target.checked = false; e.target.wasChecked = false; }
        else {
          e.target.wasChecked = true;
          [...selectBox.querySelectorAll('input[type="radio"]')].filter(r => r !== e.target).forEach(r => (r.wasChecked = false));
        }
        updateResult();
      }
    });

    // ====== ê²°ê³¼ ê°±ì‹  ======
    function updateResult() {
      if (!selectedSite) { resultBox.textContent = "í˜„ì¥ì„ ì„ íƒí•˜ì„¸ìš”."; addressText.textContent = ""; return; }
      const selectedSignal = selectBox.querySelector('input[name="signal"]:checked');
      const signalText = selectedSignal ? `[${selectedSignal.value}] ` : "";

      const siteName = selectedSite.siteName || "";
      const elevator = (selectedSite.elevator || "").replace("-", "");
      const modelInfo = selectedSite.extra || "";
      const phone = phoneBox.value.trim();
      const memo = memoBox.value.trim();
      const addrInfo = shortenAddress(selectedSite.address || "");

      const formatted = `${signalText}${siteName} ${elevator}`
        + (phone ? `\n${phone}` : "")
        + `\n${addrInfo}`
        + (memo ? `\n\n${memo}` : "")
        + (modelInfo ? `\n${modelInfo}` : "");

      resultBox.textContent = formatted;
      addressText.textContent = `${selectedSite.address || ""}\n${selectedSite.jibunAddress || ""}`;
    }

    // ====== ë„¤ì´ë²„ ì§€ë„ ì—´ê¸° ======
    naverIcon.addEventListener("click", () => {
      if (!selectedSite) return;
      const addr = encodeURIComponent(selectedSite.address || "");
      const webUrl = `https://map.naver.com/v5/search/${addr}`;
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      if (isMobile) { window.location.href = `nmap://search?query=${addr}`; setTimeout(() => { window.location.href = webUrl; }, 800); }
      else { window.open(webUrl, "_blank"); }
    });

    // ====== ë³µì‚¬/ë¦¬ì…‹ ======
    function copyResult() {
      const text = resultBox.textContent.trim();
      if (!text || text.includes("í˜„ì¥ì„ ì„ íƒ") || text.includes("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘")) return;
      navigator.clipboard.writeText(text).then(() => {
        copyNotice.textContent = "ğŸ“‹ ë³µì‚¬ ì™„ë£Œ!";
        copyNotice.classList.add("visible");
        setTimeout(() => copyNotice.classList.remove("visible"), 2500);
      });
    }
    function resetAll(e) {
      if (e) e.preventDefault();
      [...selectBox.querySelectorAll('input[type="radio"]')].forEach(r => { r.checked = false; r.wasChecked = false; });
      searchBox.value = ""; memoBox.value = ""; phoneBox.value = "";
      selectedSite = null; suggestionsDiv.innerHTML = ""; copyNotice.textContent = "";
      addressText.textContent = ""; updateResult();
    }
  </script>
</body>
</html>
