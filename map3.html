<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÎåÄÎ™ÖÏóòÎ¶¨Î≤†Ïù¥ÌÑ∞(Ï£º) ÌòÑÏû•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    #map { width: 100%; height: 90vh; }

    #speedBox {
      position: fixed; top: 12px; left: 18px; z-index: 9999;
      background: rgba(255,255,255,0.95); color: #333; border-radius: 7px;
      font-size: 15px; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 4px 14px; pointer-events: none;
    }

    .custom-popup { font-size: 14px; line-height: 1.4; white-space: normal; color: black !important; }
    .popup-scroll { max-height: 280px; overflow-y: auto; }
    .marker-label {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-weight: 700; font-size: 15px; pointer-events: none;
      user-select: none; border-radius: 50%; white-space: nowrap; letter-spacing: 2px;
    }

    #searchBox {
      position: fixed; bottom: 10px; left: 10px; max-width: 280px;
      width: calc(100vw - 40px); background: white; padding: 6px 10px;
      border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000; font-size: 14px; overflow-wrap: break-word; word-break: break-word;
    }
    #searchInput {
      width: 100%; box-sizing: border-box; padding: 4px 8px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    #searchClear {
      position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
      cursor: pointer; font-weight: bold; color: #999; user-select: none;
    }

    /* ÎÇ¥ ÏúÑÏπò Î≤ÑÌäº (Îß® ÏïÑÎûò) */
    #locationBtn {
      position: fixed; bottom: 10px; right: 10px; z-index: 1000;
      background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 8px 12px; cursor: pointer; user-select: none; display: flex; align-items: center;
      gap: 6px; font-size: 14px; color: black;
    }
    #locationBtn .circle-dot {
      width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; border:2px solid #fff;
    }

    /* Ïã†Í≥† Î≤ÑÌäº (ÎÇ¥ ÏúÑÏπò ÏúÑ 50px) */
    #alarmBtn {
      position: fixed; bottom: 60px; right: 10px; z-index: 2000; font-size: 19px;
      background: #ffdf5e; color: #dc143c; font-weight: bold; padding: 6px 15px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.14); cursor: pointer; border: 0;
    }

    /* ÌïÑÌÑ∞ Î∞ïÏä§ (Ïã†Í≥† ÏúÑ 50px) */
    .team-filter {
      position: fixed; bottom: 110px; right: 10px; max-width: 180px;
      background: white; padding: 8px 12px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000; font-size: 14px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .team-filter label { display: flex; align-items: center; cursor: pointer; }
    .team-filter input { margin-right: 6px; }

    @media (max-width: 480px) {
      .team-filter { bottom: 110px; right: 10px; max-width: 90vw; max-height: 25vh; overflow-y: auto; font-size: 13px; }
      #searchBox { bottom: 10px; left: 10px; width: calc(50vw); }
      #locationBtn { bottom: 10px; right: 10px; padding: 6px 10px; font-size: 13px; }
      #speedBox { font-size: 13px; top: 8px; left: 8px; }
    }

    #alarmPopup {
      position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
      z-index: 4000; background: #fff; border-radius: 16px; box-shadow: 0 2px 18px rgba(0,0,0,0.15);
      max-width: 420px; width: 96vw; max-height: 70vh; overflow-y: auto;
      border: 2px solid #ffe071; display: none;
    }
    #alarmPopup .alarm-list { padding: 16px; }
    .alarm-row {
      margin-bottom: 18px; padding: 10px 8px; border-radius: 10px;
      border: 1px solid #ffe3ad; background: #fff9e5;
      font-size: 15px; box-shadow: 0 1px 5px rgba(255,215,68,0.09);
    }
    .alarm-row .site { font-weight: bold; font-size: 16px; margin-bottom:4px; }
    .alarm-row .address { margin-bottom:4px; }
    .alarm-row .desc { margin-bottom:4px; }
    .alarm-row .tel-link { color: #0055bb; text-decoration: underline; font-weight: 500; cursor: pointer; }
    .alarm-row .date { font-size:13px; color:#b6b6b6; margin-top:5px; text-align:right; }

    #callPopup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5); z-index: 5001;
    }
    #callPopup .call-content {
      background: #fff; padding: 20px; border-radius: 8px; text-align: center;
    }
    #callPopup button { margin: 5px; padding: 8px 16px; font-size: 14px; }
  </style>
</head>
<body>
  <h2>ÎåÄÎ™ÖÏóòÎ¶¨Î≤†Ïù¥ÌÑ∞(Ï£º) ÌòÑÏû•</h2>
  <div id="speedBox" style="display:none">ÏÜçÎèÑ: <span id="speedVal">0</span> km/h</div>
  <div id="map"></div>

  <div id="searchBox" role="search">
    <input type="text" id="searchInput" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•" aria-label="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•" />
    <span id="searchClear" title="Í≤ÄÏÉâÏñ¥ ÏßÄÏö∞Í∏∞" aria-label="Í≤ÄÏÉâÏñ¥ ÏßÄÏö∞Í∏∞">√ó</span>
  </div>

  <div id="locationBtn" title="ÎÇ¥ ÌòÑÏû¨ ÏúÑÏπò ÌëúÏãú" role="button" tabindex="0">
    <div class="circle-dot" id="locCircle"></div> ÎÇ¥ ÏúÑÏπò
  </div>

  <button id="alarmBtn" title="Ïã†Í≥† ÌåùÏóÖ">üö® Ïã†Í≥†</button>

  <div class="team-filter" aria-label="ÌåÄ ÌïÑÌÑ∞">
    <label><input type="checkbox" value="Í∞ïÎÇ®ÌåÄ" checked> Í∞ïÎÇ®ÌåÄ <span id="cntGangnam"></span></label>
    <label><input type="checkbox" value="Í∞ïÎ∂ÅÌåÄ" checked> Í∞ïÎ∂ÅÌåÄ <span id="cntGangbuk"></span></label>
    <label><input type="checkbox" value="Í≤ÄÏÇ¨ÌïÑÏöî"> Í≤ÄÏÇ¨ÌïÑÏöî <span id="cntNeed"></span></label>
<label><input type="checkbox" value="Í≤ÄÏÇ¨Ï†ïÍ∏∞Ï†ïÎ∞Ä"> Í≤ÄÏÇ¨(Ï†ïÍ∏∞Ï†ïÎ∞Ä) <span id="cntCheck"></span></label>
  </div>

  <div id="alarmPopup">
    <div class="alarm-list"></div>
  </div>

  <div id="callPopup">
    <div class="call-content">
      <p id="callText"></p>
      <button id="callYes">Ï†ÑÌôî</button>
      <button id="callNo">Îã´Í∏∞</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // === MAP INIT ===
    const tsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpveOpTjSLo3ZOFfCaoqJlknJXl0FyhmsAy7ICy-L_EsGun7Tf9uCqZbp97_yXYQwx-p_BlTpSouwn/pub?gid=381852124&single=true&output=tsv";
    const alarmTsv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkPXudgO_znrjg8-ZyoSmMb5dhrISbANstWt3xNanbbTNCNRhDwAQgxhrECxwN8R2QSV8lTgln6_9P/pub?gid=1682703072&single=true&output=tsv";
    const map = L.map("map").setView([37.5665, 126.978], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ==== COLORS & INDEX ====
    const colors = {
      orange: "rgba(246,187,67,1)", gray: "rgba(153,153,153,0.7)",
      gray75: "rgba(153,153,153,0.5)", green: "rgba(0,192,75,1)",
      blue: "rgba(0,25,244,1)", red: "rgba(255,59,59,1)"
    };
    const idx = {
      coord:1, address:7, special:21, checkDate:11,
      wNum:23, contact:24, model:27, fan:28,
      biTongNum:26, expire:30, siteName:32,
      team:19, biTongEquip:16
    };

    // ==== STATE ====
    let coordGroups={}, markers=[], markerData=[];
    let currentLocationMarker=null, locationWatchId=null;
    let locationOnFlag=false, currentSpeed=0;

    // ==== LOCATION ====
    const locationBtn = document.getElementById("locationBtn"),
          locCircle = document.getElementById("locCircle");
    function setLocationBtn(on){
      locationOnFlag = on;
      locCircle.style.background = on ? "red" : "#ccc";
    }
    setLocationBtn(false);

    function startLocation(){
      if(!navigator.geolocation){ alert("ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§."); return; }
      setLocationBtn(true);
      if(locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
      locationWatchId = navigator.geolocation.watchPosition(pos => {
        const {latitude,longitude,heading,speed} = pos.coords;
        if(currentLocationMarker) map.removeLayer(currentLocationMarker);
        let arrow = "";
        if(heading != null && !isNaN(heading)){
          arrow = `<svg width="18" height="18" style="position:absolute;top:0;left:0;" viewBox="0 0 18 18"><polygon points="9,2 16,16 9,13 2,16" style="fill:rgba(255,0,0,0.7);stroke:#900;stroke-width:1;"/></svg>`;
        }
        currentLocationMarker = L.marker([latitude,longitude], {
          icon: L.divIcon({html: `<div style="width:18px;height:18px;background:red;border-radius:50%;border:2px solid white;position:relative;">${arrow}</div>`})
        }).addTo(map);
        map.setView([latitude,longitude],15);
        currentSpeed = (speed && !isNaN(speed)) ? speed * 3.6 : 0;
        showSpeedBox(true);
      }, _ => setLocationBtn(false));
    }
    function stopLocation(){
      setLocationBtn(false);
      if(locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
      locationWatchId = null;
      if(currentLocationMarker){ map.removeLayer(currentLocationMarker); currentLocationMarker = null; }
      showSpeedBox(false);
    }
    locationBtn.addEventListener("click", () => locationOnFlag ? stopLocation() : startLocation());

    // ==== SPEED ====
    const speedBox = document.getElementById("speedBox"),
          speedVal = document.getElementById("speedVal");
    function showSpeedBox(on){ speedBox.style.display = on ? "block" : "none"; }
    setInterval(() => { if(locationOnFlag) speedVal.textContent = Math.round(currentSpeed*10)/10; }, 700);

    // ==== SEARCH ====
    const searchInput = document.getElementById("searchInput"),
          searchClear = document.getElementById("searchClear");
    searchInput.addEventListener("input", updateMarkerHighlighting);
    searchClear.addEventListener("click", () => { searchInput.value=""; updateMarkerHighlighting(); });

    // ==== FILTER ====
    const teamFilterInputs = document.querySelectorAll(".team-filter input");
    teamFilterInputs.forEach(i => i.addEventListener("change", fetchTSVandPlot));
    const cntGangnam = document.getElementById("cntGangnam"),
          cntGangbuk = document.getElementById("cntGangbuk"),
          cntNeed = document.getElementById("cntNeed");
const cntCheck = document.getElementById("cntCheck");


    // ==== Ïã†Í≥† POPUP TOGGLE ====
    const alarmBtnEl = document.getElementById("alarmBtn"),
          alarmPopup = document.getElementById("alarmPopup"),
          alarmList = document.querySelector(".alarm-list");
    alarmBtnEl.addEventListener("click", () => {
      if(alarmPopup.style.display==="block"){
        alarmPopup.style.display="none";
      } else {
        loadAlarmTsv(); alarmPopup.style.display="block";
      }
    });
    alarmPopup.addEventListener("click", e => { if(e.target===alarmPopup) alarmPopup.style.display="none"; });
    document.addEventListener("keydown", e => { if(e.key==="Escape") alarmPopup.style.display="none"; });

    // ===== MAIN FETCH & PLOT =====
const markersMap = {}; // key = Ï¢åÌëú Î¨∏ÏûêÏó¥, Í∞í = ÎßàÏª§

async function fetchTSVandPlot() {
  const res = await fetch(tsvUrl);
  const tsvText = await res.text();
  const rows = tsvText.trim().split("\n").slice(1).map(r => r.split("\t"));

  const checkedTeams = Array.from(document.querySelectorAll('.team-filter input:checked')).map(i => i.value);
  const filterGangnam = checkedTeams.includes("Í∞ïÎÇ®ÌåÄ");
  const filterGangbuk = checkedTeams.includes("Í∞ïÎ∂ÅÌåÄ");
  const filterNeed = checkedTeams.includes("Í≤ÄÏÇ¨ÌïÑÏöî");
  const filterCheck = checkedTeams.includes("Í≤ÄÏÇ¨Ï†ïÍ∏∞Ï†ïÎ∞Ä");
  const searchTerm = searchInput.value.trim().toLowerCase();

  let cntGN = 0, cntGB = 0, totalGN = 0, totalGB = 0, cntNeedNum = 0, cntCheckNum = 0;
  const coordGroups = {};
  const newKeys = new Set();

  rows.forEach(row => {
    const team = row[idx.team] || "";
    if (team.includes("Ìï¥ÏßÄ")) return;

    const coordStr = row[idx.coord];
    if (!coordStr) return;
    const [latS, lngS] = coordStr.split(",");
    if (!lngS) return;
    const lat = parseFloat(latS), lng = parseFloat(lngS);
    if (isNaN(lat) || isNaN(lng)) return;

    const siteName = row[idx.siteName] || "";
    const address = row[idx.address] || "";
    const contact = row[idx.contact] || "";
    const expire = row[idx.expire] || "";
    const checkDate = row[idx.checkDate] || "";

    const dDay = calcDateDiffNumber(expire);
    const isNeed = dDay !== null && dDay <= 0 && dDay >= -60;
    if (isNeed) cntNeedNum++;

    const checkD = calcDateDiffNumber(checkDate);
    const isCheckValid = checkD !== null && checkD >= -30 && checkD <= 0;
    if (isCheckValid) cntCheckNum++;

    if (team.includes("Í∞ïÎÇ®ÌåÄ")) totalGN++;
    if (team.includes("Í∞ïÎ∂ÅÌåÄ")) totalGB++;

    const hasDate = !!checkDate && isValidDate(checkDate);
    if (team.includes("Í∞ïÎÇ®ÌåÄ") && hasDate) cntGN++;
    if (team.includes("Í∞ïÎ∂ÅÌåÄ") && hasDate) cntGB++;

    let show = false, color = "", labelText = "", zIndex = 500;

    const matchesSearch = () => {
      const combined = `${siteName} ${address} ${contact}`.toLowerCase();
      return combined.includes(searchTerm);
    };

    // ‚úÖ Í≤ÄÏÉâÏù¥ ÏµúÏö∞ÏÑ†
    if (searchTerm && matchesSearch()) {
      show = true;
      color = colors.orange;
      labelText = "";
      zIndex = 1000;

    } else if (filterNeed) {
      show = true;
      if (isNeed) {
        color = colors.red;
        labelText = `${Math.abs(dDay)}`;
        zIndex = 1000;
      } else {
        color = colors.gray75;
        zIndex = 100;
      }

    } else if (filterCheck) {
      show = true;
      if (isCheckValid) {
        color = colors.red;
        labelText = `${Math.abs(checkD)}`;
        zIndex = 1000;
      } else {
        color = colors.gray75;
        labelText = "";
        zIndex = 100;
      }

    } else if ((filterGangnam && team.includes("Í∞ïÎÇ®ÌåÄ")) || (filterGangbuk && team.includes("Í∞ïÎ∂ÅÌåÄ"))) {
      show = true;
      if (hasDate && checkDate !== expire) {
        color = colors.gray;
        zIndex = 100;
      } else {
        color = team.includes("Í∞ïÎÇ®ÌåÄ") ? colors.green : colors.blue;
        zIndex = 1000;
      }
    }

    if (!show) return;

    const key = `${lat.toFixed(6)},${lng.toFixed(6)}`;
    newKeys.add(key);
    if (!coordGroups[key]) coordGroups[key] = { lat, lng, entries: [], color, labelText, zIndex };
    coordGroups[key].entries.push(row);
  });

  cntGangnam.textContent = ` (${cntGN}/${totalGN || 1})`;
  cntGangbuk.textContent = ` (${cntGB}/${totalGB || 1})`;
  cntNeed.textContent = ` (${cntNeedNum})`;
  cntCheck.textContent = ` (${cntCheckNum})`;

  Object.entries(coordGroups).forEach(([key, group]) => {
    const { lat, lng, entries, color, labelText, zIndex } = group;
    let label = labelText;
    if (!label && entries.length > 1) label = `${entries.length}`;

    const labelHtml = label
      ? `<div class="marker-label" style="font-size:12px; letter-spacing:-1px;">&nbsp;${label}</div>`
      : "";

    const html = `<div style="position:relative;width:18px;height:18px;">
      <div style="background-color:${color};width:18px;height:18px;border-radius:50%;border:2px solid white;"></div>
      ${labelHtml}
    </div>`;

    const icon = L.divIcon({
      html, iconSize: [18, 18], iconAnchor: [9, 9], popupAnchor: [0, -9], className: ""
    });

    const existing = markersMap[key];
    if (existing) {
      const old = existing.__meta || {};
      const changed = old.color !== color || old.labelText !== labelText;
      if (changed) {
        existing.setIcon(icon);
        existing.setZIndexOffset(zIndex);
        existing.__meta = { color, labelText };
      }
    } else {
      const marker = L.marker([lat, lng], { icon, zIndexOffset: zIndex }).addTo(map);
      const popupHtml = entries.map(row => {
        const sn = row[idx.siteName] || "", addr = row[idx.address] || "", sp = row[idx.special] || "",
              cd = row[idx.checkDate] || "", wr = row[idx.wNum] || "", ct = row[idx.contact] || "",
              md = row[idx.model] || "", fn = row[idx.fan] || "", bt = row[idx.biTongNum] || "",
              eq = row[idx.biTongEquip] || "", ex = row[idx.expire] || "";
        const wp = wr.replace(/\D/g, '').padStart(7, "0");
        const dm = calcDateDiff(ex);
        const nlink = `nmap://search?query=${encodeURIComponent(addr)}`;
        return `
          <strong><a href="https://m.elevator.go.kr/qrcode.do?no_plaq=${wp}" target="_blank">${sn} (${wp})</a></strong><br/>
          <a href="${nlink}" target="_blank">${addr}</a><br/>
          üìû <a href="tel:${ct.replace(/\D/g, '')}">${ct}</a><br/>
          ÌäπÏù¥ÏÇ¨Ìï≠: ${sp}<br/>
          Ï†êÍ≤Ä: ${cd}<br/>
          Í∏∞Ï¢Ö: ${md}<br/>
          Fan: ${fn}<br/>
          ÎπÑÌÜµÎ≤àÌò∏: ${bt}<br/>
          ÎπÑÌÜµÏû•ÎπÑ: ${eq}<br/>
          Ïú†Ìö®Í∏∞Í∞Ñ: ${ex} ${dm}
          <hr/>`;
      }).join("");

      const wrappedPopup = `<div class="popup-scroll">${popupHtml}</div>`.replace(/<hr\/>\s*<\/div>$/, '</div>');
      marker.bindPopup(wrappedPopup);
      marker.__meta = { color, labelText };
      markersMap[key] = marker;
    }
  });

  Object.keys(markersMap).forEach(key => {
    if (!newKeys.has(key)) {
      map.removeLayer(markersMap[key]);
      delete markersMap[key];
    }
  });

  updateMarkerHighlighting();
}
    // ==== UTILITIES ====
    function calcDateDiff(ds){
      if(!ds) return "";
      let c=ds.replace(/[^\d\-]/g,'').replace(/-{2,}/g,'-');
      if(/^\d{8}$/.test(c)) c=c.replace(/^(\d{4})(\d{2})(\d{2})$/,'$1-$2-$3');
      const d=new Date(c), now=new Date();
      if(isNaN(d)) return "";
      const diff=Math.floor((d.getTime()-now.getTime())/(1000*60*60*24));
      return diff>=0?`D-${diff}`:`D+${Math.abs(diff)}`;
    }
    function calcDateDiffNumber(ds){
      if(!ds) return null;
      let c=ds.replace(/[^\d\-]/g,'').replace(/-{2,}/g,'-');
      if(/^\d{8}$/.test(c)) c=c.replace(/^(\d{4})(\d{2})(\d{2})$/,'$1-$2-$3');
      const d=new Date(c), now=new Date();
      if(isNaN(d)) return null;
      return Math.floor((d.getTime()-now.getTime())/(1000*60*60*24));
    }
    function isValidDate(ds){
      const d=new Date(ds);
      return !isNaN(d);
    }
    function getPopupSearchableText(html){
      const noLinks=html.replace(/<a\b[^>]*>.*?<\/a>/gi,'');
      return noLinks.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
    }
    function updateMarkerHighlighting(){
      const term=searchInput.value.trim().toLowerCase();
      markerData.forEach(o=>{
        let content=o.popupHtmlOriginal;
        let hit=false;
        if(term){
          const txt=getPopupSearchableText(content).toLowerCase();
          if(txt.includes(term)){
            content=content
              .replace(/(<a\b[^>]*>.*?<\/a>)/gi,m=>m.replace(new RegExp(term,'gi'),'@@#@@'))
              .replace(new RegExp(term,'gi'),'<span class="highlight-text">$&</span>')
              .replace(/@@#@@/g,term);
            hit=true;
          }
        }
        const newColor=term?(hit?colors.orange:colors.gray75):o.baseColor;
        o.marker.setIcon(L.divIcon({
          html:o.createMarkerHtml(newColor),
          iconSize:[18,18],iconAnchor:[9,9],popupAnchor:[0,-9],className:""
        }));
        o.marker.getPopup().setContent(content);
      });
    }

    // ==== LOAD Ïã†Í≥† TSV ====
let lastAlarmKeys = new Set();
let isFirstAlarmLoad = true;

async function loadAlarmTsv() {
  if (alarmPopup.style.display !== "block") return;

  const res = await fetch(alarmTsv);
  const txt = await res.text();
  const rows = txt.trim().split("\n").slice(1).map(r => r.split("\t"));
  rows.sort((a, b) => {
    const da = a[0]?.trim(), db = b[0]?.trim();
    if (!da && !db) return 0;
    if (!da) return 1;
    if (!db) return -1;
    return db.localeCompare(da);
  });

  const isMobile = /Android|iPhone|iPad|iPod/.test(navigator.userAgent);
  const list = document.querySelector(".alarm-list");

  // üö® Ï†úÎ™©Ïù¥ ÏóÜÎã§Î©¥ Ï≤òÏùåÏóê ÎÑ£Í∏∞
  if (!list.querySelector("h3")) {
    list.innerHTML = `<h3>üö® Ïã†Í≥† Ï†ëÏàòÎÇ¥Ïó≠</h3>`;
  }

  const currentItems = new Set();
  const newItems = [];

  rows.forEach(r => {
    const date = r[0]?.trim() || "", content = r[7]?.trim() || "";
    if (!content) return;
    const key = date + content;
    currentItems.add(key);

    const parts = content.split(" / ");
    const a = parts[0] || "", b = parts[1] || "", c = parts[2] || "";

    let linkA = a;
    const idMatch = a.match(/(\d{4}-\d{3})/);
    if (idMatch) {
      const idNum = idMatch[1].replace("-", "");
      linkA = `<a href="https://m.elevator.go.kr/qrcode.do?no_plaq=${idNum}" target="_blank">${a}</a>`;
    }

    const linkB = isMobile
      ? `<a href="nmap://search?query=${encodeURIComponent(b)}" target="_blank">${b}</a>`
      : `<a href="https://map.naver.com/v5/search/${encodeURIComponent(b)}" target="_blank">${b}</a>`;

    const phoneMatch = c.match(/(0\d{1,2}-\d{3,4}-\d{4}|01\d-\d{3,4}-\d{4})/);
    const phone = phoneMatch ? phoneMatch[1] : "";
    const linkC = `<span class="call-trigger" data-phone="${phone}">${c}</span>`;

    const block = `
      <div class="alarm-row" data-key="${key}">
        <div class="site">${linkA}</div>
        <div class="address">${linkB}</div>
        <div class="desc">${linkC}</div>  
        <div class="date">${date}</div>
      </div>`;

    if (!lastAlarmKeys.has(key) && !isFirstAlarmLoad) {
      newItems.push({ key, html: block });
    } else if (isFirstAlarmLoad) {
      list.insertAdjacentHTML("beforeend", block);
    }
  });

  // ‚ú® ÏÉà Ìï≠Î™© ÏÇΩÏûÖ (üö® Ï†úÎ™© ÏïÑÎûò)
  if (!isFirstAlarmLoad && newItems.length > 0) {
    const header = list.querySelector("h3");
    const insertPoint = header ? header.nextSibling : null;

    newItems.reverse().forEach(({ key, html }) => {
      const temp = document.createElement("div");
      temp.innerHTML = html.trim();
      const node = temp.firstChild;
      node.dataset.key = key;

      list.insertBefore(node, insertPoint);

      let i = 0;
      const blink = setInterval(() => {
        node.style.opacity = node.style.opacity === "0.1" ? "1" : "0.1";
        if (++i >= 20) {
          clearInterval(blink);
          node.style.opacity = "1";
        }
      }, 200);
    });
  }

  // üßπ ÏÇ¨ÎùºÏßÑ Ìï≠Î™© Ï†úÍ±∞
  const allRows = Array.from(list.querySelectorAll(".alarm-row"));
  allRows.forEach(node => {
    const key = node.dataset.key;
    if (!currentItems.has(key)) node.remove();
  });

  lastAlarmKeys = currentItems;
  isFirstAlarmLoad = false;
}

// ÏµúÏ¥à Î°úÎî©
loadAlarmTsv();

// 5Ï¥àÎßàÎã§ ÏÉàÎ°úÍ≥†Ïπ® (ÌåùÏóÖÏù¥ Ïó¥Î†§ÏûàÏùÑ ÎïåÎßå)
setInterval(loadAlarmTsv, 5000);
    // ==== CALL POPUP HANDLERS ====
    const callPopupEl = document.getElementById("callPopup"),
          callText = document.getElementById("callText"),
          callYes = document.getElementById("callYes"),
          callNo = document.getElementById("callNo");
    let currentPhone = "";
    alarmList.addEventListener("click", e=>{
      if(e.target.matches(".call-trigger")){
        currentPhone = e.target.dataset.phone;
        callText.textContent = `${currentPhone}Î°ú Ï†ÑÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
        callPopupEl.style.display = "flex";
      }
    });
    callYes.addEventListener("click", ()=>{ window.location.href = `tel:${currentPhone.replace(/\D/g,"")}`; });
    callNo.addEventListener("click", ()=>{ callPopupEl.style.display = "none"; });

    fetchTSVandPlot();
  </script>
</body>
</html>
