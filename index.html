<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>지도와 현장 표시</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
<style>
  #map { width: 100%; height: 90vh; }
  .custom-popup {
    font-size: 14px;
    line-height: 1.4;
    white-space: nowrap;
    color: black !important;
  }
  .marker-label {
    position: absolute;
    /* 숫자 위치는 JS에서 동적으로 조절 */
    color: white;
    font-weight: 700;
    pointer-events: none;
    user-select: none;
    line-height: 1;
    border-radius: 50%;
  }
  .team-filter {
    position: fixed;
    top: 10px;
    right: 10px;
    background: white;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
    font-size: 14px;
  }
  .team-filter label {
    display: block;
    margin-bottom: 6px;
    cursor: pointer;
    user-select: none;
  }
  #searchBox {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: white;
    padding: 6px 10px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 14px;
  }
  #searchInput {
    width: 220px;
    padding: 4px 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  #searchClear {
    margin-left: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #999;
    user-select: none;
  }
  #locationBtn {
    position: fixed;
    bottom: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: black;
  }
  #locationBtn .red-dot {
    width: 14px;
    height: 14px;
    background: red;
    border-radius: 50%;
    flex-shrink: 0;
  }
</style>
</head>
<body>
<h2>현장 위치 지도</h2>

<div class="team-filter">
  <label><input type="checkbox" value="강남팀" checked> 강남팀</label>
  <label><input type="checkbox" value="강북팀" checked> 강북팀</label>
  <label><input type="checkbox" value="검사필요"> 검사필요 (유효기간 D-90 이하)</label>
</div>

<div id="map"></div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="검색어 입력" />
  <span id="searchClear" title="검색어 지우기">×</span>
</div>

<div id="locationBtn" title="내 현재 위치 표시">
  <div class="red-dot"></div> 내 위치
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
  const tsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpveOpTjSLo3ZOFfCaoqJlknJXl0FyhmsAy7ICy-L_EsGun7Tf9uCqZbp97_yXYQwx-p_BlTpSouwn/pub?gid=381852124&single=true&output=tsv";

  const map = L.map("map").setView([37.5665, 126.978], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  const idx = {
    coord: 1,       // B열: 위도,경도 (콤마 구분)
    address: 7,     // H열: 주소
    special: 21,    // V열: 특이사항
    checkDate: 11,  // L열: 점검
    wNum: 23,       // X열: 비통번호 (7자리 숫자)
    contact: 24,    // Y열: 연락처
    model: 27,      // AB열: 기종
    fan: 28,        // AC열: Fan
    biTongNum: 26,  // AA열: 비통번호
    expire: 30,     // AE열: 유효기간
    siteName: 32,   // AG열: 현장명
    team: 19        // T열: 팀명 (강남팀, 강북팀 등)
  };

  let coordGroups = {};
  let markers = [];
  let markerData = []; // [{marker, popupHtmlOriginal, baseColor, inspectionNeeded}]

  const highlightMarkerColor = "#F6BB43"; // 주황색
  const inspectionMarkerColor = "#ff0000"; // 검사필요 빨간색
  const highlightTextColor = "red";

  // 내 위치 마커
  let currentLocationMarker = null;

  // 유효기간 D-숫자에서 숫자 추출
  function getDDayValue(dateStr) {
    const ddayText = calcDateDiff(dateStr); // "D-XX"
    const match = ddayText.match(/D-(\d+)/);
    if (match) return parseInt(match[1], 10);
    return null;
  }

  // 기본 마커 스케일 (최대 1.05배)
  function getBaseMarkerScale() {
    const baseWidth = 600;
    const currentWidth = window.innerWidth || baseWidth;
    const scale = currentWidth / baseWidth;
    return Math.min(Math.max(scale, 1), 1.05);
  }

  // 하이라이트 마커 스케일 (최대 1.5배)
  function getHighlightMarkerScale() {
    const baseWidth = 600;
    const currentWidth = window.innerWidth || baseWidth;
    const scale = currentWidth / baseWidth;
    return Math.min(Math.max(scale, 1), 1.5);
  }

  // 검사필요 필터 체크 여부
  function isInspectionNeededFilterChecked() {
    return document.querySelector('.team-filter input[value="검사필요"]').checked;
  }

  // 검사필요 조건 - D-90 이하
  function isInspectionNeeded(expireDateStr) {
    if (!expireDateStr) return false;
    const dday = getDDayValue(expireDateStr);
    if (dday === null) return false;
    return dday <= 90;
  }

  async function fetchTSVandPlot() {
    // 기존 마커 제거
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    markerData = [];
    coordGroups = {};

    const res = await fetch(tsvUrl);
    const tsvText = await res.text();

    const rows = tsvText.trim().split("\n").map(row => row.split("\t"));
    const data = rows.slice(1);

    // 체크된 팀 가져오기
    const checkedTeams = Array.from(document.querySelectorAll('.team-filter input:checked')).map(i => i.value);

    data.forEach(row => {
      const coordStr = row[idx.coord];
      if (!coordStr) return;
      const parts = coordStr.split(",");
      if (parts.length !== 2) return;
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (isNaN(lat) || isNaN(lng)) return;

      const team = row[idx.team] || "";
      if (!checkedTeams.some(t => team.includes(t))) {
        // 검사필요 필터는 team 컬럼에 없음, 별도로 검사
        if (checkedTeams.includes("검사필요")) {
          // 검사필요 필터 켜져 있으면 검사필요 여부 체크
          const expire = row[idx.expire] || "";
          if (!isInspectionNeeded(expire)) return;  // 검사필요 아니면 패스
        } else {
          return; // 팀 필터 미포함이면 패스
        }
      }

      const checkDateVal = row[idx.checkDate] || "";

      let color = "";
      if (checkDateVal && isValidDate(checkDateVal)) {
        color = "#999999"; // 회색
      } else if (team.includes("강남팀")) {
        color = "#00c04b"; // 녹색
      } else if (team.includes("강북팀")) {
        color = "#0019f4"; // 파랑
      } else {
        color = "#888888"; // 기타 기본색 (회색)
      }

      const key = lat.toFixed(6) + "," + lng.toFixed(6);

      if (!coordGroups[key]) {
        coordGroups[key] = {
          lat,
          lng,
          color,
          entries: []
        };
      }
      coordGroups[key].entries.push(row);
    });

    Object.values(coordGroups).forEach(group => {
      const {lat, lng, color, entries} = group;
      const count = entries.length;
      const row = entries[0];

      const siteName = row[idx.siteName] || "";
      const addr = row[idx.address] || "";
      const special = row[idx.special] || "";
      const checkDate = row[idx.checkDate] || "";
      const wRaw = row[idx.wNum] || "";
      const contact = row[idx.contact] || "";
      const model = row[idx.model] || "";
      const fan = row[idx.fan] || "";
      const biTongNum = row[idx.biTongNum] || "";
      const expire = row[idx.expire] || "";

      const wNumPadded = wRaw.toString().replace(/\D/g, '').padStart(7, "0");
      const naverSearch = encodeURIComponent(addr);
      const dMinus = calcDateDiff(expire);
      const formattedWNum = formatWNum(wRaw);

      let fanCircleHtml = "";
      const fanLower = fan.toLowerCase();
      if(fanLower === "on"){
        fanCircleHtml = `<span style="color: green; font-weight:bold; font-size: 18px; line-height: 1;">●</span>`;
      } else if(fanLower === "off"){
        fanCircleHtml = `<span style="color: red; font-weight:bold; font-size: 18px; line-height: 1;">●</span>`;
      } else {
        fanCircleHtml = fan ? `<span>${fan}</span>` : "";
      }

      const popupHtml = `
        <div class="custom-popup" style="color:black">
          <strong><a href="https://m.elevator.go.kr/qrcode.do?no_plaq=${wNumPadded}" target="_blank" rel="noopener noreferrer" style="color:black; text-decoration:none;">
          ${siteName} ${formattedWNum}</a></strong><br/>
          <a href="https://map.naver.com/p/search/${naverSearch}" target="_blank" rel="noopener noreferrer" style="color:black;">${addr}</a><br/>
          📞 ${contact}<br/>
          특이사항: ${special}<br/>
          점검: ${checkDate}<br/>
          기종: ${model}<br/>
          Fan: ${fanCircleHtml}<br/>
          비통번호: ${biTongNum}<br/>
          유효기간: ${expire} ${dMinus}
        </div>`;

      // 검사필요 여부 판단
      const inspectionNeeded = isInspectionNeeded(expire) && isInspectionNeededFilterChecked();

      // 마커 색상 및 크기 결정
      const markerColor = inspectionNeeded ? inspectionMarkerColor : color;

      const baseScale = getBaseMarkerScale();
      const highlightScale = getHighlightMarkerScale();

      // 기본 마커 크기: 18px, 검사필요 마커는 20% 확대 + highlightScale 적용
      const size = inspectionNeeded
        ? 18 * highlightScale * 1.2
        : 18 * baseScale;

      // 숫자 위치 top % (비례 적용)
      const labelTopPercent = 70 * (size / 18);

      // 숫자 글꼴 크기 비례 (약 2/3 크기)
      const fontSize = Math.round(size * 0.66);

      const countLabel = count > 1
        ? `<div class="marker-label" style="
            background-color: ${markerColor};
            width: ${size}px;
            height: ${size}px;
            line-height: ${size}px;
            font-size: ${fontSize}px;
            position: absolute;
            top: ${labelTopPercent}%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            border-radius: 50%;
            pointer-events: none;
            user-select: none;
          ">${count}</div>`
        : "";

      const markerHtml = `
        <div style="position: relative; width: ${size}px; height: ${size}px;">
          <div style="
            background-color: ${markerColor};
            width: ${size}px;
            height: ${size}px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.4);
          "></div>
          ${countLabel}
        </div>`;

      const icon = L.divIcon({
        className: "",
        html: markerHtml,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        popupAnchor: [0, -size * 0.6]
      });

      const marker = L.marker([lat, lng], { icon: icon })
        .addTo(map)
        .bindPopup(popupHtml);

      markers.push(marker);
      markerData.push({
        marker,
        popupHtmlOriginal: popupHtml,
        baseColor: color,
        inspectionNeeded
      });
    });
  }

  // 날짜 유효성 검사
  function isValidDate(d) {
    return !isNaN(new Date(d).getTime());
  }

  // 날짜 차이 계산 (D-숫자 리턴)
  function calcDateDiff(dateStr) {
    if (!dateStr) return "";
    let cleanDateStr = dateStr
      .replace(/[^\d\-]/g, '')
      .replace(/-{2,}/g, '-');

    if(/^\d{8}$/.test(cleanDateStr)) {
      cleanDateStr = cleanDateStr.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
    }

    const today = new Date();
    const target = new Date(cleanDateStr);
    if (isNaN(target)) return "";
    const diffTime = target.getTime() - today.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return `D-${diffDays}`;
  }

  function formatWNum(numStr) {
    const numOnly = numStr.toString().replace(/\D/g, '').padStart(7, "0");
    return numOnly.slice(0,4) + "-" + numOnly.slice(4);
  }

  // 검색어 포함 여부로 팝업 텍스트 내 하이라이트, 마커 색 변경
  function updatePopupHighlight(keyword) {
    const lowerKeyword = keyword.trim().toLowerCase();
    if (lowerKeyword === "") {
      markerData.forEach(({ marker, popupHtmlOriginal, baseColor, inspectionNeeded }) => {
        if (!marker.getPopup()) return;
        marker.setPopupContent(popupHtmlOriginal);
        setMarkerColor(marker, inspectionNeeded ? inspectionMarkerColor : baseColor);
      });
      return;
    }

    markerData.forEach(({ marker, popupHtmlOriginal, baseColor, inspectionNeeded }) => {
      if (!marker.getPopup()) return;

      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = popupHtmlOriginal;
      const textContent = tempDiv.textContent.toLowerCase();

      if (textContent.includes(lowerKeyword)) {
        const keywordEscaped = escapeRegExp(keyword);
        const regex = new RegExp(keywordEscaped, "gi");
        const newHtml = popupHtmlOriginal.replace(regex, match => `<span style="color:${highlightTextColor}">${match}</span>`);
        marker.setPopupContent(newHtml);
        setMarkerColor(marker, highlightMarkerColor);
      } else {
        marker.setPopupContent(popupHtmlOriginal);
        setMarkerColor(marker, inspectionNeeded ? inspectionMarkerColor : baseColor);
      }
    });
  }

  // 마커 색상 및 크기 다시 세팅 (검색 하이라이트/검사필요 포함)
  function setMarkerColor(marker, color) {
    const oldIcon = marker.getIcon();
    const iconHtml = oldIcon.options.html;
    const countLabelMatch = iconHtml.match(/<div class="marker-label" style="([^"]+)">(\d+)<\/div>/);

    const countLabelHtml = countLabelMatch 
      ? `<div class="marker-label" style="${countLabelMatch[1].replace(/background-color:[^;]+;/, `background-color: ${color};`)}">${countLabelMatch[2]}</div>`
      : "";

    // 크기는 기존 아이콘 크기 유지
    const size = oldIcon.options.iconSize[0];
    const labelTopPercent = 50 * (size / 18);
    const fontSize = Math.round(size * 0.66);

    const newCountLabelHtml = countLabelMatch
      ? `<div class="marker-label" style="
          background-color: ${color};
          width: ${size}px;
          height: ${size}px;
          line-height: ${size}px;
          font-size: ${fontSize}px;
          position: absolute;
          top: ${labelTopPercent}%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: white;
          font-weight: 700;
          border-radius: 50%;
          pointer-events: none;
          user-select: none;
        ">${countLabelMatch[2]}</div>`
      : "";

    const newHtml = `
      <div style="position: relative; width: ${size}px; height: ${size}px;">
        <div style="
          background-color: ${color};
          width: ${size}px;
          height: ${size}px;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 0 3px rgba(0,0,0,0.4);
        "></div>
        ${newCountLabelHtml}
      </div>`;

    const newIcon = L.divIcon({
      className: "",
      html: newHtml,
      iconSize: [size, size],
      iconAnchor: [size/2, size/2],
      popupAnchor: [0, -size*0.6]
    });

    marker.setIcon(newIcon);
  }

  // 검색어 특수문자 이스케이프
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  // 검색 기능
  document.getElementById("searchInput").addEventListener("input", (e) => {
    updatePopupHighlight(e.target.value);
  });

  document.getElementById("searchClear").addEventListener("click", () => {
    const input = document.getElementById("searchInput");
    input.value = "";
    updatePopupHighlight("");
    input.focus();
  });

  // 필터 체크박스 변경 시 마커 재로드
  document.querySelectorAll('.team-filter input').forEach(cb => {
    cb.addEventListener('change', () => {
      fetchTSVandPlot();
      // 검색 초기화
      document.getElementById("searchInput").value = "";
      updatePopupHighlight("");
    });
  });

  // 내 위치 버튼
  document.getElementById("locationBtn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("이 브라우저에서는 위치 정보를 지원하지 않습니다.");
      return;
    }
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      if (currentLocationMarker) {
        map.removeLayer(currentLocationMarker);
      }
      currentLocationMarker = L.marker([lat, lng], {
        title: "내 위치",
        icon: L.divIcon({
          className: "",
          html: '<div style="width:18px;height:18px;background:blue;border-radius:50%;border:3px solid white;"></div>',
          iconSize: [24,24],
          iconAnchor: [12,12]
        })
      }).addTo(map);
      map.setView([lat, lng], 15);
    }, () => {
      alert("위치 정보를 가져올 수 없습니다.");
    });
  });

  // 초기 로드
  fetchTSVandPlot();

</script>
</body>
</html>
