<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì§€ë„ì™€ í˜„ì¥ í‘œì‹œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
<style>
  #map { width: 100%; height: 90vh; }
  .custom-popup {
    font-size: 14px;
    line-height: 1.4;
    white-space: nowrap;
    color: black !important;
  }
  .marker-label {
    position: absolute;
    top: 50%;       /* ì„¸ë¡œ ì¤‘ì•™ */
    left: 50%;      /* ê°€ë¡œ ì¤‘ì•™ */
    transform: translate(-50%, -50%);
    color: white;
    font-weight: 700;
    font-size: 14px; /* ìˆ«ì í¬ê¸° 90% ê¸°ì¤€ ì¡°ì • */
    pointer-events: none;
    user-select: none;
    line-height: 1;
  }
  .team-filter {
    position: fixed;
    top: 10px;
    right: 10px;
    background: white;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
    font-size: 14px;
  }
  .team-filter label {
    display: block;
    margin-bottom: 6px;
    cursor: pointer;
  }
  #searchBox {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: white;
    padding: 6px 10px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 14px;
  }
  #searchInput {
    width: 220px;
    padding: 4px 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  #searchClear {
    margin-left: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #999;
    user-select: none;
  }
  #locationBtn {
    position: fixed;
    bottom: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: black;
  }
  #locationBtn .red-dot {
    width: 14px;
    height: 14px;
    background: red;
    border-radius: 50%;
    flex-shrink: 0;
  }
  /* ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ë°©í–¥ ì‚¼ê°í˜• */
  .current-location-marker {
    position: relative;
    width: 30px;
    height: 30px;
  }
  .current-location-circle {
    width: 30px;
    height: 30px;
    background: red;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
  }
  .current-location-arrow {
    position: absolute;
    top: 5px;
    left: 50%;
    margin-left: -6px;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 12px solid white;
    transform-origin: 50% 100%;
  }
</style>
</head>
<body>
<h2>í˜„ì¥ ìœ„ì¹˜ ì§€ë„</h2>

<div class="team-filter">
  <label><input type="checkbox" value="ê°•ë‚¨íŒ€" checked> ê°•ë‚¨íŒ€</label>
  <label><input type="checkbox" value="ê°•ë¶íŒ€" checked> ê°•ë¶íŒ€</label>
  <label><input type="checkbox" value="ê²€ì‚¬í•„ìš”"> ê²€ì‚¬í•„ìš”</label>
</div>

<div id="map"></div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
  <span id="searchClear" title="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">Ã—</span>
</div>

<div id="locationBtn" title="ë‚´ í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ">
  <div class="red-dot"></div> ë‚´ ìœ„ì¹˜
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
  const tsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpveOpTjSLo3ZOFfCaoqJlknJXl0FyhmsAy7ICy-L_EsGun7Tf9uCqZbp97_yXYQwx-p_BlTpSouwn/pub?gid=381852124&single=true&output=tsv";

  const map = L.map("map").setView([37.5665, 126.978], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  // Aì—´ë¶€í„° 0ë²ˆ ì¸ë±ìŠ¤ ê¸°ì¤€, ë¹„í†µì¥ë¹„ëŠ” Qì—´ = 16ë²ˆì§¸ ì¸ë±ìŠ¤(0ë¶€í„°)
  const idx = {
    coord: 1,       // Bì—´: ìœ„ë„,ê²½ë„ (ì½¤ë§ˆ êµ¬ë¶„)
    address: 7,     // Hì—´: ì£¼ì†Œ
    special: 21,    // Vì—´: íŠ¹ì´ì‚¬í•­
    checkDate: 11,  // Lì—´: ì ê²€
    wNum: 23,       // Xì—´: ë¹„í†µë²ˆí˜¸ (7ìë¦¬ ìˆ«ì)
    contact: 24,    // Yì—´: ì—°ë½ì²˜
    model: 27,      // ABì—´: ê¸°ì¢…
    fan: 28,        // ACì—´: Fan
    biTongNum: 26,  // AAì—´: ë¹„í†µë²ˆí˜¸
    expire: 30,     // AEì—´: ìœ íš¨ê¸°ê°„
    siteName: 32,   // AGì—´: í˜„ì¥ëª…
    team: 19,       // Tì—´: íŒ€ëª… (ê°•ë‚¨íŒ€, ê°•ë¶íŒ€ ë“±)
    biTongEquip: 16 // Qì—´: ë¹„í†µì¥ë¹„
  };

  let coordGroups = {};
  let markers = [];
  let markerData = []; // [{marker, popupHtmlOriginal, baseColor, count}]

  const highlightMarkerColor = "#F6BB43"; // ì£¼í™©ìƒ‰
  const highlightTextColor = "red";

  // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ë° ë°©í–¥ í‘œì‹œ
  let currentLocationMarker = null;
  let currentHeading = 0; // ë°©í–¥ ê°ë„

  // ë‚´ ìœ„ì¹˜ ë°©í–¥ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateCurrentLocationMarker(latlng) {
    if (!currentLocationMarker) {
      const iconHtml = `
        <div class="current-location-marker">
          <div class="current-location-circle"></div>
          <div class="current-location-arrow" style="transform: rotate(${currentHeading}deg);"></div>
        </div>`;
      const icon = L.divIcon({
        className: '',
        html: iconHtml,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
      currentLocationMarker = L.marker(latlng, {icon: icon}).addTo(map);
    } else {
      currentLocationMarker.setLatLng(latlng);
      const arrowEl = currentLocationMarker.getElement().querySelector('.current-location-arrow');
      if (arrowEl) {
        arrowEl.style.transform = `rotate(${currentHeading}deg)`;
      }
    }
  }

  // ë‚´ ìœ„ì¹˜ ë°©í–¥ ì„¼ì„œ ì´ë²¤íŠ¸
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientationabsolute', e => {
      if (e.absolute && e.alpha !== null) {
        // alpha ê°’ì€ 0~360, 0ì€ ë¶ìª½
        currentHeading = 360 - e.alpha; // ë°˜ì‹œê³„ ë°©í–¥ ë³´ì •
        if (currentLocationMarker) {
          const arrowEl = currentLocationMarker.getElement().querySelector('.current-location-arrow');
          if (arrowEl) arrowEl.style.transform = `rotate(${currentHeading}deg)`;
        }
      }
    }, true);
    // fallback for deviceorientation event if deviceorientationabsolute not supported
    window.addEventListener('deviceorientation', e => {
      if (e.alpha !== null) {
        currentHeading = 360 - e.alpha;
        if (currentLocationMarker) {
          const arrowEl = currentLocationMarker.getElement().querySelector('.current-location-arrow');
          if (arrowEl) arrowEl.style.transform = `rotate(${currentHeading}deg)`;
        }
      }
    }, true);
  }

  async function fetchTSVandPlot() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    markerData = [];
    coordGroups = {};

    const res = await fetch(tsvUrl);
    const tsvText = await res.text();

    const rows = tsvText.trim().split("\n").map(row => row.split("\t"));
    const data = rows.slice(1);

    // ì²´í¬ëœ íŒ€ ê°€ì ¸ì˜¤ê¸°
    const checkedTeams = Array.from(document.querySelectorAll('.team-filter input:checked')).map(i => i.value);
    const inspectionNeededChecked = checkedTeams.includes("ê²€ì‚¬í•„ìš”");

    data.forEach(row => {
      const coordStr = row[idx.coord];
      if (!coordStr) return;
      const parts = coordStr.split(",");
      if (parts.length !== 2) return;
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (isNaN(lat) || isNaN(lng)) return;

      const team = row[idx.team] || "";
      if (inspectionNeededChecked) {
        const expire = row[idx.expire] || "";
        const dDay = calcDateDiffNumber(expire);
        if (dDay === null || dDay > 90) return;
      } else {
        if (!checkedTeams.some(t => t === "ê°•ë‚¨íŒ€" || t === "ê°•ë¶íŒ€")) return;
        if (!checkedTeams.some(t => team.includes(t))) return;
      }

      const checkDateVal = row[idx.checkDate] || "";

      let color = "";
      if (inspectionNeededChecked) {
        color = "#FF3B3B"; // ë¹¨ê°„ìƒ‰ ê²€ì‚¬í•„ìš”
      } else if (checkDateVal && isValidDate(checkDateVal)) {
        color = "#999999"; // íšŒìƒ‰
      } else if (team.includes("ê°•ë‚¨íŒ€")) {
        color = "#00c04b"; // ë…¹ìƒ‰
      } else if (team.includes("ê°•ë¶íŒ€")) {
        color = "#0019f4"; // íŒŒë‘
      } else {
        return;
      }

      const key = lat.toFixed(6) + "," + lng.toFixed(6);

      if (!coordGroups[key]) {
        coordGroups[key] = {
          lat,
          lng,
          color,
          entries: []
        };
      }
      coordGroups[key].entries.push(row);
    });

    Object.values(coordGroups).forEach(group => {
      const {lat, lng, color, entries} = group;
      const count = entries.length;
      const row = entries[0];

      const siteName = row[idx.siteName] || "";
      const addr = row[idx.address] || "";
      const special = row[idx.special] || "";
      const checkDate = row[idx.checkDate] || "";
      const wRaw = row[idx.wNum] || "";
      const contact = row[idx.contact] || "";
      const model = row[idx.model] || "";
      const fan = row[idx.fan] || "";
      const biTongNum = row[idx.biTongNum] || "";
      const expire = row[idx.expire] || "";
      const biTongEquip = row[idx.biTongEquip] || "";

      const wNumPadded = wRaw.toString().replace(/\D/g, '').padStart(7, "0");
      const naverSearch = encodeURIComponent(addr);
      const dMinus = calcDateDiff(expire);
      const formattedWNum = formatWNum(wRaw);

      let fanCircleHtml = "";
      const fanLower = fan.toLowerCase();
      if(fanLower === "on"){
        fanCircleHtml = `<span style="color: green; font-weight:bold; font-size: 18px; line-height: 1;">â—</span>`;
      } else if(fanLower === "off"){
        fanCircleHtml = `<span style="color: red; font-weight:bold; font-size: 18px; line-height: 1;">â—</span>`;
      } else {
        fanCircleHtml = fan ? `<span>${fan}</span>` : "";
      }

      // ì£¼ì†Œ ë§í¬ë¥¼ naver app ì‹¤í–‰ ë§í¬ë¡œ ë³€ê²½
      const naverAppLink = `nmap://search?query=${naverSearch}&appname=com.example.myapp`;

      const popupHtml = `
        <div class="custom-popup" style="color:black">
          <strong><a href="https://m.elevator.go.kr/qrcode.do?no_plaq=${wNumPadded}" target="_blank" rel="noopener noreferrer" style="color:black; text-decoration:none;">
          ${siteName} ${formattedWNum}</a></strong><br/>
          <a href="${naverAppLink}" target="_blank" rel="noopener noreferrer" style="color:black;">${addr}</a><br/>
          ğŸ“ ${contact}<br/>
          íŠ¹ì´ì‚¬í•­: ${special}<br/>
          ì ê²€: ${checkDate}<br/>
          ê¸°ì¢…: ${model}<br/>
          Fan: ${fanCircleHtml}<br/>
          ë¹„í†µë²ˆí˜¸: ${biTongNum}<br/>
          ë¹„í†µì¥ë¹„: ${biTongEquip}<br/>
          ìœ íš¨ê¸°ê°„: ${expire} ${dMinus}
        </div>`;

      const markerColor = color;
      const markerSize = (color === "#FF3B3B") ? 22 : 18; // ë¹¨ê°„ìƒ‰ì¼ ë•Œ 20% í¬ê²Œ

      // ìˆ«ìê°€ ì› ì•ˆì— ê½‰ ì°¨ë„ë¡ 90% ë¹„ìœ¨ë¡œ ì¡°ì •
      const countLabelSize = markerSize * 0.9;

      const countLabel = count > 1
        ? `<div class="marker-label" style="
            background-color: ${markerColor};
            width: ${countLabelSize}px;
            height: ${countLabelSize}px;
            line-height: ${countLabelSize}px;
            font-size: ${countLabelSize * 0.7}px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            border-radius: 50%;
            pointer-events: none;
            user-select: none;
          ">${count}</div>`
        : `<div class="marker-label" style="
            width: ${countLabelSize}px;
            height: ${countLabelSize}px;
            line-height: ${countLabelSize}px;
            font-size: ${countLabelSize * 0.7}px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            border-radius: 50%;
            pointer-events: none;
            user-select: none;
          ">1</div>`;

      const markerHtml = `
        <div style="position: relative; width: ${markerSize}px; height: ${markerSize}px;">
          <div style="
            background-color: ${markerColor};
            width: ${markerSize}px;
            height: ${markerSize}px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.4);
          "></div>
          ${countLabel}
        </div>`;

      const icon = L.divIcon({
        className: "",
        html: markerHtml,
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize / 2, markerSize / 2],
        popupAnchor: [0, -markerSize / 2]
      });

      const marker = L.marker([lat, lng], { icon: icon })
        .addTo(map)
        .bindPopup(popupHtml);

      markers.push(marker);
      markerData.push({
        marker,
        popupHtmlOriginal: popupHtml,
        baseColor: color,
        count
      });
    });
  }

  function calcDateDiff(dateStr) {
    if (!dateStr) return "";
    let cleanDateStr = dateStr
      .replace(/[^\d\-]/g, '')
      .replace(/-{2,}/g, '-');

    if(/^\d{8}$/.test(cleanDateStr)) {
      cleanDateStr = cleanDateStr.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
    }

    const today = new Date();
    const target = new Date(cleanDateStr);
    if (isNaN(target)) return "";
    const diffTime = target.getTime() - today.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return `D-${diffDays}`;
  }

  function calcDateDiffNumber(dateStr) {
    if (!dateStr) return null;
    let cleanDateStr = dateStr
      .replace(/[^\d\-]/g, '')
      .replace(/-{2,}/g, '-');

    if(/^\d{8}$/.test(cleanDateStr)) {
      cleanDateStr = cleanDateStr.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
    }

    const today = new Date();
    const target = new Date(cleanDateStr);
    if (isNaN(target)) return null;
    const diffTime = target.getTime() - today.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  }

  function formatWNum(numStr) {
    const numOnly = numStr.toString().replace(/\D/g, '').padStart(7, "0");
    return numOnly.slice(0,4) + "-" + numOnly.slice(4);
  }

  function isValidDate(d) {
    return !isNaN(new Date(d).getTime());
  }

  // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸ ë° ë§ˆì»¤ ìƒ‰ ë³€ê²½
  function updatePopupHighlight(keyword) {
    const lowerKeyword = keyword.trim().toLowerCase();
    if (lowerKeyword === "") {
      markerData.forEach(({ marker, popupHtmlOriginal, baseColor }) => {
        if (!marker.getPopup()) return;
        marker.setPopupContent(popupHtmlOriginal);
        setMarkerColor(marker, baseColor);
      });
      return;
    }

    markerData.forEach(({ marker, popupHtmlOriginal, baseColor }) => {
      if (!marker.getPopup()) return;

      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = popupHtmlOriginal;
      const textContent = tempDiv.textContent.toLowerCase();

      if (textContent.includes(lowerKeyword)) {
        const keywordEscaped = escapeRegExp(keyword);
        const regex = new RegExp(keywordEscaped, "gi");
        const newHtml = popupHtmlOriginal.replace(regex, match => `<span style="color:${highlightTextColor}">${match}</span>`);
        marker.setPopupContent(newHtml);
        setMarkerColor(marker, highlightMarkerColor);
        // ê²€ìƒ‰ëœ ë§ˆì»¤ë¥¼ ìœ„ë¡œ ì˜¬ë¦¬ê³  í™•ëŒ€
        enlargeAndBringToFront(marker);
      } else {
        marker.setPopupContent(popupHtmlOriginal);
        setMarkerColor(marker, baseColor);
        resetMarkerSize(marker, baseColor);
      }
    });
  }

  function setMarkerColor(marker, color) {
    const iconHtml = marker.getIcon().options.html;
    // ìƒ‰ìƒë§Œ êµì²´ (ì› ë°°ê²½ìƒ‰)
    const newHtml = iconHtml.replace(/background-color: #[0-9a-fA-F]{6};/, `background-color: ${color};`);
    const iconSize = marker.getIcon().options.iconSize;
    const icon = L.divIcon({
      className: "",
      html: newHtml,
      iconSize: iconSize,
      iconAnchor: [iconSize[0] / 2, iconSize[1] / 2],
      popupAnchor: [0, -iconSize[1] / 2]
    });
    marker.setIcon(icon);
  }

  // ë§ˆì»¤ í™•ëŒ€ íš¨ê³¼(ê²€ìƒ‰ ì‹œ)
  function enlargeAndBringToFront(marker) {
    const iconSize = marker.getIcon().options.iconSize;
    const enlargedSize = [iconSize[0] * 1.3, iconSize[1] * 1.3];

    const iconHtml = marker.getIcon().options.html.replace(/width: \d+px;/, `width: ${enlargedSize[0]}px;`)
                                                   .replace(/height: \d+px;/, `height: ${enlargedSize[1]}px;`);

    const icon = L.divIcon({
      className: "",
      html: iconHtml,
      iconSize: enlargedSize,
      iconAnchor: [enlargedSize[0] / 2, enlargedSize[1] / 2],
      popupAnchor: [0, -enlargedSize[1] / 2]
    });
    marker.setIcon(icon);
    marker.bringToFront();
  }

  // ë§ˆì»¤ í¬ê¸° ë¦¬ì…‹
  function resetMarkerSize(marker, color) {
    const baseSize = 18;
    const markerHtml = `
      <div style="position: relative; width: ${baseSize}px; height: ${baseSize}px;">
        <div style="
          background-color: ${color};
          width: ${baseSize}px;
          height: ${baseSize}px;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 0 3px rgba(0,0,0,0.4);
        "></div>
        <div class="marker-label" style="
          width: ${baseSize * 0.9}px;
          height: ${baseSize * 0.9}px;
          line-height: ${baseSize * 0.9}px;
          font-size: ${(baseSize * 0.9) * 0.7}px;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: white;
          font-weight: 700;
          border-radius: 50%;
          pointer-events: none;
          user-select: none;
        ">1</div>
      </div>`;
    const icon = L.divIcon({
      className: "",
      html: markerHtml,
      iconSize: [baseSize, baseSize],
      iconAnchor: [baseSize / 2, baseSize / 2],
      popupAnchor: [0, -baseSize / 2]
    });
    marker.setIcon(icon);
  }

  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // í•„í„° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
  document.querySelectorAll(".team-filter input").forEach(checkbox => {
    checkbox.addEventListener("change", () => {
      fetchTSVandPlot();
    });
  });

  // ê²€ìƒ‰ ì´ë²¤íŠ¸
  const searchInput = document.getElementById("searchInput");
  const searchClear = document.getElementById("searchClear");

  searchInput.addEventListener("input", () => {
    const val = searchInput.value.trim();
    updatePopupHighlight(val);
  });

  searchClear.addEventListener("click", () => {
    searchInput.value = "";
    updatePopupHighlight("");
  });

  // ë‚´ ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  document.getElementById("locationBtn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      updateCurrentLocationMarker(latlng);
      map.setView(latlng, 15);
    }, err => {
      alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }, { enableHighAccuracy: true });
  });

  fetchTSVandPlot();
</script>
</body>
</html>
