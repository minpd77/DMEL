<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì§€ë„ì™€ í˜„ì¥ í‘œì‹œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
<style>
  #map { width: 100%; height: 90vh; }
  .custom-popup {
    font-size: 14px;
    line-height: 1.4;
    white-space: normal;
    color: black !important;
  }
  .popup-scroll {
    max-height: 280px;
    overflow-y: auto;
  }
  .marker-label {
    position: absolute;
    top: 50%;       
    left: 50%;      
    transform: translate(-50%, -50%);
    color: white;
    font-weight: 700;
    font-size: calc(18px * 0.8);
    pointer-events: none;
    user-select: none;
    line-height: 1;
    border-radius: 50%;
  }
  .team-filter {
    position: fixed;
    top: 10px;
    right: 10px;
    background: white;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
    font-size: 14px;
  }
  .team-filter label {
    display: block;
    margin-bottom: 6px;
    cursor: pointer;
  }
  #searchBox {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: white;
    padding: 6px 10px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 14px;
  }
  #searchInput {
    width: 220px;
    padding: 4px 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  #searchClear {
    margin-left: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #999;
    user-select: none;
  }
  #locationBtn {
    position: fixed;
    bottom: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: black;
  }
  #locationBtn .red-dot {
    width: 14px;
    height: 14px;
    background: red;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes blink {
    0%, 100% { background-color: #F6BB43; }
    50% { background-color: #FFD966; }
  }
  .blinking-marker > div {
    animation: blink 1.5s infinite;
  }

  /* ê²€ìƒ‰ì–´ ë§¤ì¹­ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
  .highlight-text {
    color: red !important;
    font-weight: 700;
  }
</style>
</head>
<body>
<h2>í˜„ì¥ ìœ„ì¹˜ ì§€ë„</h2>

<div class="team-filter">
  <label><input type="checkbox" value="ê°•ë‚¨íŒ€" checked> ê°•ë‚¨íŒ€</label>
  <label><input type="checkbox" value="ê°•ë¶íŒ€" checked> ê°•ë¶íŒ€</label>
  <label><input type="checkbox" value="ê²€ì‚¬í•„ìš”"> ê²€ì‚¬í•„ìš”</label>
</div>

<div id="map"></div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
  <span id="searchClear" title="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">Ã—</span>
</div>

<div id="locationBtn" title="ë‚´ í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ">
  <div class="red-dot"></div> ë‚´ ìœ„ì¹˜
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
  const tsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpveOpTjSLo3ZOFfCaoqJlknJXl0FyhmsAy7ICy-L_EsGun7Tf9uCqZbp97_yXYQwx-p_BlTpSouwn/pub?gid=381852124&single=true&output=tsv";

  const map = L.map("map").setView([37.5665, 126.978], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  const idx = {
    coord: 1,
    address: 7,
    special: 21,
    checkDate: 11,
    wNum: 23,
    contact: 24,
    model: 27,
    fan: 28,
    biTongNum: 26,
    expire: 30,
    siteName: 32,
    team: 19,
    biTongEquip: 16
  };

  let coordGroups = {};
  let markers = [];
  let markerData = [];

  const highlightMarkerColor = "#F6BB43";
  const highlightTextColor = "red";

  let currentLocationMarker = null;
  let inspectionNeededChecked = false;

  const teamFilterInputs = document.querySelectorAll(".team-filter input");
  const searchInput = document.getElementById("searchInput");
  const searchClear = document.getElementById("searchClear");

  // ì´ë²¤íŠ¸ ë“±ë¡
  teamFilterInputs.forEach(input => {
    input.addEventListener("change", () => {
      fetchTSVandPlot();
    });
  });

  searchInput.addEventListener("input", () => {
    updateMarkerHighlighting();
  });

  searchClear.addEventListener("click", () => {
    searchInput.value = "";
    updateMarkerHighlighting();
  });

  document.getElementById("locationBtn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      if (currentLocationMarker) {
        map.removeLayer(currentLocationMarker);
      }
      currentLocationMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
          html: `<div style="width: 18px; height: 18px; background: red; border-radius: 50%; border: 2px solid white;"></div>`,
          className: ""
        }),
        zIndexOffset: 1000
      }).addTo(map);
      map.setView([latitude, longitude], 15);
    });
  });

  async function fetchTSVandPlot() {
    // ì´ˆê¸°í™”
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    markerData = [];
    coordGroups = {};

    const res = await fetch(tsvUrl);
    const tsvText = await res.text();

    const rows = tsvText.trim().split("\n").map(r => r.split("\t"));
    const data = rows.slice(1);

    // í•„í„° ì²´í¬ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    const checkedTeams = Array.from(document.querySelectorAll('.team-filter input:checked')).map(i => i.value);
    inspectionNeededChecked = checkedTeams.includes("ê²€ì‚¬í•„ìš”");

    // ì£¼ì†Œ ê·¸ë£¹í•‘ìš© Map: key=ìœ„ë„,ê²½ë„
    data.forEach(row => {
      const team = row[idx.team] || "";

      // Tì—´ì— "í•´ì§€" í¬í•¨ ì‹œ ì œì™¸
      if(team.includes("í•´ì§€")) return;

      // ìœ„ë„ ê²½ë„ ì¶”ì¶œ
      const coordStr = row[idx.coord];
      if (!coordStr) return;
      const parts = coordStr.split(",");
      if (parts.length !== 2) return;
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (isNaN(lat) || isNaN(lng)) return;

      // ê²€ì‚¬í•„ìš” í•„í„° í™œì„± ì‹œ
      if (inspectionNeededChecked) {
        const expire = row[idx.expire] || "";
        const dDayNum = calcDateDiffNumber(expire);

        // 60ì¼ ì´ˆê³¼ë©´ ì œì™¸
        if (dDayNum === null || dDayNum > 60) return;
      } else {
        // ê²€ì‚¬í•„ìš” í•„í„°ê°€ ì•„ë‹ˆë©´ íŒ€ í•„í„° ì ìš©
        if (!(checkedTeams.includes("ê°•ë‚¨íŒ€") || checkedTeams.includes("ê°•ë¶íŒ€"))) return;
        if (!checkedTeams.some(t => team.includes(t))) return;
      }

      // ê¸°ë³¸ ìƒ‰ìƒ ê²°ì •
      let color = "";
      if (inspectionNeededChecked) {
        color = "#FF3B3B";
      } else if (row[idx.checkDate] && isValidDate(row[idx.checkDate])) {
        color = "#999999";
      } else if (team.includes("ê°•ë‚¨íŒ€")) {
        color = "#00c04b";
      } else if (team.includes("ê°•ë¶íŒ€")) {
        color = "#0019f4";
      } else {
        return;
      }

      const key = lat.toFixed(6) + "," + lng.toFixed(6);
      if (!coordGroups[key]) {
        coordGroups[key] = {
          lat,
          lng,
          color,
          entries: []
        };
      }
      coordGroups[key].entries.push(row);
    });

    // ê·¸ë£¹ ë‚´ entries ìŠ¹ê°•ê¸°ë²ˆí˜¸ ë¹ ë¥¸ ìˆœ ì •ë ¬
    Object.values(coordGroups).forEach(group => {
      group.entries.sort((a,b) => {
        const aNum = parseInt((a[idx.wNum]||"").replace(/\D/g,"").padStart(7,"0"));
        const bNum = parseInt((b[idx.wNum]||"").replace(/\D/g,"").padStart(7,"0"));
        return aNum - bNum;
      });
    });

    // ë§ˆì»¤ ìƒì„±
    Object.values(coordGroups).forEach(group => {
      const {lat, lng, color, entries} = group;
      const count = entries.length;
      const showCount = count > 1;

      // íŒì—… html ìƒì„± (ì„¸íŠ¸ êµ¬ë¶„ í…ìŠ¤íŠ¸ í¬í•¨)
      let popupParts = [];
      // ëª¨ë“  ì„¸íŠ¸ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ êµ¬í˜„ ê°€ëŠ¥ (í˜„ì¬ëŠ” ê·¸ëƒ¥ ëª¨ë‘ ë‚˜ì—´)
      entries.forEach((row, idxSet) => {
        const setTitle = count > 1 ? `<strong style="color:#444;">${idxSet+1}ì„¸íŠ¸</strong><br>` : "";
        const siteName = row[idx.siteName] || "";
        const addr = row[idx.address] || "";
        const special = row[idx.special] || "";
        const checkDate = row[idx.checkDate] || "";
        const wRaw = row[idx.wNum] || "";
        const contact = row[idx.contact] || "";
        const model = row[idx.model] || "";
        const fan = row[idx.fan] || "";
        const biTongNum = row[idx.biTongNum] || "";
        const expire = row[idx.expire] || "";
        const biTongEquip = row[idx.biTongEquip] || "";

        const wNumPadded = wRaw.toString().replace(/\D/g, '').padStart(7, "0");
        const nmapLink = `nmap://search?query=${encodeURIComponent(addr)}&appname=com.example.myapp`;
        const dMinusRaw = calcDateDiff(expire);
        const dMinus = dMinusRaw ? dMinusRaw.replace(/--+/g, "-") : "";

        let fanCircleHtml = "";
        const fanLower = fan.toLowerCase();
        if(fanLower === "on"){
          fanCircleHtml = `<span style="color: green; font-weight:bold; font-size: 18px; line-height: 1;">â—</span>`;
        } else if(fanLower === "off"){
          fanCircleHtml = `<span style="color: red; font-weight:bold; font-size: 18px; line-height: 1;">â—</span>`;
        } else {
          fanCircleHtml = fan ? `<span>${fan}</span>` : "";
        }

        popupParts.push(`
          ${setTitle}
          <strong><a href="https://m.elevator.go.kr/qrcode.do?no_plaq=${wNumPadded}" target="_blank" rel="noopener noreferrer" style="color:black; text-decoration:none;">
          ${siteName} ${formatWNum(wRaw)}</a></strong><br/>
          <a href="${nmapLink}" target="_blank" rel="noopener noreferrer" style="color:black;">${addr}</a><br/>
          ğŸ“ ${contact}<br/>
          íŠ¹ì´ì‚¬í•­: ${special}<br/>
          ì ê²€: ${checkDate}<br/>
          ê¸°ì¢…: ${model}<br/>
          Fan: ${fanCircleHtml}<br/>
          ë¹„í†µë²ˆí˜¸: ${biTongNum}<br/>
          ë¹„í†µì¥ë¹„: ${biTongEquip}<br/>
          ìœ íš¨ê¸°ê°„: ${expire} ${dMinus}
          <hr style="margin:6px 0; border:0; border-top:1px solid #ddd;" />
        `);
      });

      let popupHtmlRaw = `<div class="popup-scroll">${popupParts.join("")}</div>`;
      popupHtmlRaw = popupHtmlRaw.replace(/<hr[^>]*>\s*<\/div>$/, '</div>');

      const markerSize = 18;
      const countLabel = showCount
        ? `<div class="marker-label" style="
            width: ${markerSize}px;
            height: ${markerSize}px;
            line-height: ${markerSize}px;
            font-size: calc(${markerSize}px * 0.8);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            pointer-events: none;
            user-select: none;
            border-radius: 50%;
          ">${count}</div>`
        : "";

      // ë§ˆì»¤ html ìƒì„± í•¨ìˆ˜
      function createMarkerHtml(color) {
        return `
          <div style="position: relative; width: ${markerSize}px; height: ${markerSize}px;">
            <div style="
              background-color: ${color};
              width: ${markerSize}px;
              height: ${markerSize}px;
              border-radius: 50%;
              border: 2px solid white;
              box-shadow: 0 0 3px rgba(0,0,0,0.4);
              transition: background-color 0.3s ease;
            "></div>
            ${countLabel}
          </div>`;
      }

      let markerColor = color;

      // ê²€ìƒ‰ì–´ ì¼ì¹˜ ì‹œ ìƒ‰ìƒ ë³€ê²½ì€ updateMarkerHighlighting í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬

      // ê²€ì‚¬í•„ìš” + 35ì¼ ì´ë‚´ì¼ ê²½ìš° ê¹œë¹¡ì„ íš¨ê³¼ í´ë˜ìŠ¤ ë¶€ì—¬
      let addBlinking = false;
      if(inspectionNeededChecked){
        const firstExpire = entries[0][idx.expire] || "";
        const dDayFirst = calcDateDiffNumber(firstExpire);
        if(dDayFirst !== null && dDayFirst <= 35){
          addBlinking = true;
        }
      }

      const iconOptions = {
        className: addBlinking ? "blinking-marker" : "",
        html: createMarkerHtml(markerColor),
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize / 2, markerSize / 2],
        popupAnchor: [0, -markerSize / 2]
      };

      const icon = L.divIcon(iconOptions);

      const marker = L.marker([lat, lng], { icon: icon })
        .addTo(map)
        .bindPopup(popupHtmlRaw);

      markers.push(marker);
      markerData.push({
        marker,
        popupHtmlOriginal: popupHtmlRaw,
        baseColor: markerColor,
        entries,
        createMarkerHtml,
        markerSize
      });
    });

    updateMarkerHighlighting();
  }

  // ë‚ ì§œ D-day ê³„ì‚° ë° 60ì¼ ì´ˆê³¼ ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
  function calcDateDiff(dateStr) {
    if (!dateStr) return "";
    let cleanDateStr = dateStr
      .replace(/[^\d\-]/g, '')
      .replace(/-{2,}/g, '-');

    if(/^\d{8}$/.test(cleanDateStr)) {
      cleanDateStr = cleanDateStr.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
    }

    const today = new Date();
    const target = new Date(cleanDateStr);
    if (isNaN(target)) return "";

    const diffTime = target.getTime() - today.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if(diffDays > 60) return "";

    return `D-${diffDays}`;
  }

  // ë‚ ì§œ ì°¨ì´ ìˆ«ì ë°˜í™˜
  function calcDateDiffNumber(dateStr) {
    if (!dateStr) return null;
    let cleanDateStr = dateStr
      .replace(/[^\d\-]/g, '')
      .replace(/-{2,}/g, '-');

    if(/^\d{8}$/.test(cleanDateStr)) {
      cleanDateStr = cleanDateStr.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
    }

    const today = new Date();
    const target = new Date(cleanDateStr);
    if (isNaN(target)) return null;

    const diffTime = target.getTime() - today.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  }

  // ìŠ¹ê°•ê¸° ë²ˆí˜¸ í¬ë§·íŒ… 0000-0000 í˜•íƒœ (ê¸°ì¡´ëŒ€ë¡œ)
  function formatWNum(numStr) {
    const numOnly = numStr.toString().replace(/\D/g, '').padStart(7, "0");
    return numOnly.slice(0,4) + "-" + numOnly.slice(4);
  }

  // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
  function isValidDate(dateStr) {
    if (!dateStr) return false;
    let cleanDateStr = dateStr
      .replace(/[^\d\-]/g, '')
      .replace(/-{2,}/g, '-');
    if(/^\d{8}$/.test(cleanDateStr)) {
      cleanDateStr = cleanDateStr.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3');
    }
    const d = new Date(cleanDateStr);
    return !isNaN(d);
  }

  // ê²€ìƒ‰ì–´ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ìˆ«ì, ë¬¸ì í¬í•¨) - ì „í™”ë²ˆí˜¸ ì¼ë¶€ í¬í•¨ ê°€ëŠ¥í•˜ë„ë¡ ë‹¨ìˆœ í¬í•¨ ê²€ì‚¬
  function searchMatch(text, query) {
    if (!text || !query) return false;
    return text.toLowerCase().indexOf(query.toLowerCase()) >= 0;
  }

  // ë§ˆì»¤, íŒì—… í…ìŠ¤íŠ¸ ê²€ìƒ‰ì–´ í¬í•¨ ì‹œ í•˜ì´ë¼ì´íŠ¸ ë° ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½ + ìœ„ë¡œ ì˜¬ë¦¬ê¸°
  function updateMarkerHighlighting() {
    const query = searchInput.value.trim();
    if (!query) {
      // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒ ë³µì›, ë§ˆì»¤ zIndex ì´ˆê¸°í™”
      markerData.forEach(({marker, baseColor, popupHtmlOriginal}) => {
        marker.setIcon(L.divIcon({
          className: marker.options.icon.options.className || "",
          html: baseColor ? createMarkerHtmlStatic(baseColor) : "",
          iconSize: [18, 18],
          iconAnchor: [9, 9],
          popupAnchor: [0, -9]
        }));
        marker.setZIndexOffset(0);

        // íŒì—… í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ
        if(marker.getPopup()){
          marker.setPopupContent(popupHtmlOriginal);
        }
      });
      return;
    }

    // ê²€ìƒ‰ì–´ê°€ ìˆì„ ê²½ìš° ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½ ë° íŒì—… ë‚´ í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
    markerData.forEach(({marker, baseColor, popupHtmlOriginal, entries, createMarkerHtml, markerSize}, idx) => {
      let matched = false;

      // íŒì—… ë‚´ìš© ë‚´ í•˜ì´ë¼ì´íŠ¸í•  ë¶€ë¶„
      let modifiedPopup = popupHtmlOriginal;

      // entries ë³„ë¡œ ê²€ìƒ‰ì–´ í¬í•¨ ì²´í¬í•´ì„œ í•˜ì´ë¼ì´íŠ¸
      entries.forEach(row => {
        // ì£¼ì†Œ, ì—°ë½ì²˜, ìŠ¹ê°•ê¸°ë²ˆí˜¸ ë“±ì—ì„œ ê²€ìƒ‰ì–´ í¬í•¨ ê²€ì‚¬
        const fieldsToCheck = [
          row[idx.address] || "",
          row[idx.contact] || "",
          row[idx.wNum] || ""
        ];

        if(fieldsToCheck.some(field => searchMatch(field, query))){
          matched = true;
        }
      });

      if(matched){
        // ë§ˆì»¤ ìƒ‰ìƒ ì£¼í™©ìœ¼ë¡œ ë³€ê²½, zIndexOffset ìµœëŒ€í™”
        marker.setZIndexOffset(9999);
        // ê¹œë¹¡ì„ ì œê±° (ê²€ìƒ‰ ì¤‘ ê¹œë¹¡ì„ ì—†ê²Œ)
        const iconHtml = createMarkerHtml(highlightMarkerColor);
        marker.setIcon(L.divIcon({
          className: "",
          html: iconHtml,
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize / 2, markerSize / 2],
          popupAnchor: [0, -markerSize / 2]
        }));

        // íŒì—… í…ìŠ¤íŠ¸ ë‚´ ê²€ìƒ‰ì–´ í¬í•¨ ë‹¨ì–´ ë¹¨ê°„ìƒ‰ í•˜ì´ë¼ì´íŠ¸
        let highlightedPopup = popupHtmlOriginal;

        // ì •ê·œì‹: ê²€ìƒ‰ì–´ë¥¼ ë¬¸ì ê·¸ëŒ€ë¡œ, ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ì „ì—­
        const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedQuery, 'gi');

        highlightedPopup = highlightedPopup.replace(regex, match => `<span class="highlight-text">${match}</span>`);

        marker.setPopupContent(highlightedPopup);

      } else {
        // ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì›ë˜ ìƒ‰ìƒ, zIndex ì´ˆê¸°í™”
        marker.setZIndexOffset(0);

        const iconHtml = createMarkerHtml(baseColor);
        marker.setIcon(L.divIcon({
          className: marker.options.icon.options.className || "",
          html: iconHtml,
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize / 2, markerSize / 2],
          popupAnchor: [0, -markerSize / 2]
        }));

        // íŒì—… í…ìŠ¤íŠ¸ ë³µì›
        marker.setPopupContent(popupHtmlOriginal);
      }
    });
  }

  // createMarkerHtml í•¨ìˆ˜ (static, ìƒ‰ìƒ ì…ë ¥ë°›ìŒ)
  function createMarkerHtmlStatic(color) {
    const markerSize = 18;
    return `
      <div style="position: relative; width: ${markerSize}px; height: ${markerSize}px;">
        <div style="
          background-color: ${color};
          width: ${markerSize}px;
          height: ${markerSize}px;
          border-radius: 50%;
          border: 2px solid white;
          box-shadow: 0 0 3px rgba(0,0,0,0.4);
          transition: background-color 0.3s ease;
        "></div>
      </div>`;
  }

  fetchTSVandPlot();
</script>
</body>
</html>
