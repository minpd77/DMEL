<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì˜¤í”ˆìŠ¤íŠ¸ë¦¬íŠ¸ë§µ ì§€ë„ + ë§ˆì»¤</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+4w6b0g53veTn3pQoDjHya79TyGxnzYaZa0n0w3oY="
  crossorigin=""
/>
<style>
  #map {
    width: 100vw;
    height: 100vh;
  }
  .custom-popup {
    font-size: 14px;
    line-height: 1.4;
  }
  .custom-popup a {
    color: blue;
    text-decoration: underline;
  }
</style>
</head>
<body>
<div id="map"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j6D+2/k9fQ+I7rjN1D6bVV2VFK3zFw4g+v0yYZo="
  crossorigin=""
></script>
<script>
  // êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ TSV ë°ì´í„° URL
  const TSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpveOpTjSLo3ZOFfCaoqJlknJXl0FyhmsAy7ICy-L_EsGun7Tf9uCqZbp97_yXYQwx-p_BlTpSouwn/pub?gid=381852124&single=true&output=tsv";

  // íŒ€ë³„ ìƒ‰ìƒ ì¡°ê±´
  function getMarkerColor(team, hasDate) {
    if (hasDate) return "gray"; // ë‚ ì§œ ìˆìœ¼ë©´ íšŒìƒ‰
    if (team === "ê°•ë‚¨íŒ€") return "green";
    if (team === "ê°•ë¶íŒ€") return "blue";
    return "red"; // ë‹¤ë¥¸ íŒ€ ë˜ëŠ” ë¹ˆê°’ì¼ ê²½ìš° ë¹¨ê°„ìƒ‰
  }

  // ìˆ«ìë¥¼ 7ìë¦¬ë¡œ ì•ì— 0ì±„ìš°ê¸°
  function padSeven(numStr) {
    return numStr.padStart(7, "0");
  }

  // QRì½”ë“œ ë§í¬ ë§Œë“¤ê¸° (wì—´ 7ìë¦¬ ìˆ«ì ì—°ì†)
  function makeQrLink(numStr) {
    const cleanNum = numStr.replace(/-/g, "");
    const padded = padSeven(cleanNum);
    return `https://m.elevator.go.kr/qrcode.do?no_plaq=${padded}`;
  }

  // íŒì—… ë‚´ìš© ìƒì„±
  function createPopupContent(data) {
    /*
      data = {
        í˜„ì¥ëª…: string,  // agì—´
        wë²ˆí˜¸: string,    // wì—´ (7ìë¦¬ ìˆ«ì, í•˜ì´í”ˆ í¬í•¨ ê°€ëŠ¥)
        ì£¼ì†Œ: string,     // gì—´
        ì—°ë½ì²˜: string,   // xì—´
        íŠ¹ì´ì‚¬í•­: string, // vì—´
        ê¸°ì¢…: string,     // aaì—´
        Fan: string,      // abì—´
        ë¹„ìƒí†µí™”: string, // zì—´
        ìœ íš¨ê¸°ê°„: string, // adì—´
        íŒ€: string,       // sì—´ (ê°•ë‚¨íŒ€, ê°•ë¶íŒ€ ì™¸ ë¬´ì‹œ)
        ë‚ ì§œì¡´ì¬: boolean // kì—´ ë‚ ì§œ ì¡´ì¬ ì—¬ë¶€
      }
    */

    const qrLink = makeQrLink(data.wë²ˆí˜¸);

    // wë²ˆí˜¸ í•˜ì´í”ˆ í¬í•¨ 3-4ìë¦¬ë¡œ ì¶œë ¥ (ex: 0114-421)
    const wClean = data.wë²ˆí˜¸.replace(/-/g, "").padStart(7, "0");
    const wFormatted = wClean.slice(0, 4) + "-" + wClean.slice(4);

    return `
      <div class="custom-popup">
        <b><a href="${qrLink}" target="_blank">${data.í˜„ì¥ëª…} ${wFormatted}</a></b><br/>
        ${data.ì£¼ì†Œ}<br/>
        ğŸ“: ${data.ì—°ë½ì²˜}<br/>
        íŠ¹ì´ì‚¬í•­: ${data.íŠ¹ì´ì‚¬í•­}<br/>
        ê¸°ì¢…: ${data.ê¸°ì¢…}<br/>
        Fan: ${data.Fan}<br/>
        ë¹„ìƒí†µí™”: ${data.ë¹„ìƒí†µí™”}<br/>
        ìœ íš¨ê¸°ê°„: ${data.ìœ íš¨ê¸°ê°„}<br/>
      </div>
    `;
  }

  async function fetchTsvData(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("TSV ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
    const tsvText = await res.text();
    return tsvText.trim().split("\n").map(line => line.split("\t"));
  }

  function parseDateExistence(dateStr) {
    // ê°„ë‹¨í•˜ê²Œ ë¹ˆ ë¬¸ìì—´ ì•„ë‹Œì§€ í™•ì¸
    return dateStr && dateStr.trim() !== "";
  }

  // ì§€ë„ ì´ˆê¸°í™”
  const map = L.map("map").setView([37.5665, 126.978], 11);

  // ì˜¤í”ˆìŠ¤íŠ¸ë¦¬íŠ¸ë§µ íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // ë©”ì¸ í•¨ìˆ˜
  async function main() {
    try {
      const rows = await fetchTsvData(TSV_URL);
      const header = rows[0];
      const dataRows = rows.slice(1);

      // ì—´ ì¸ë±ìŠ¤ ì°¾ê¸° (ì•ŒíŒŒë²³ ê¸°ì¤€)
      // Aì—´: 0, Bì—´:1 ... AGì—´: 32, Wì—´: 22, Gì—´:6 ë“±
      const colIndex = {
        ìœ„ë„: 1, // Bì—´
        ê²½ë„: 2, // Cì—´ (ë§Œì•½ ê²½ë„ ë‹¤ë¥´ë©´ ë°”ê¿”ì£¼ì„¸ìš”)
        í˜„ì¥ëª…: 32, // AGì—´
        wë²ˆí˜¸: 22, // Wì—´
        ì£¼ì†Œ: 6, // Gì—´
        ì—°ë½ì²˜: 23, // Xì—´
        íŠ¹ì´ì‚¬í•­: 21, // Vì—´
        ê¸°ì¢…: 26, // AAì—´
        Fan: 27, // ABì—´
        ë¹„ìƒí†µí™”: 25, // Zì—´
        ìœ íš¨ê¸°ê°„: 29, // ADì—´
        íŒ€: 18, // Sì—´
        ë‚ ì§œ: 10 // Kì—´
      };

      // ë™ì¼ ì£¼ì†Œ ê·¸ë£¹í•‘ (ì£¼ì†Œ + í˜„ì¥ëª…) ì¤‘ë³µ ì¹´ìš´íŠ¸
      const addressCountMap = new Map();
      dataRows.forEach(row => {
        const addr = row[colIndex.ì£¼ì†Œ]?.trim() || "";
        const name = row[colIndex.í˜„ì¥ëª…]?.trim() || "";
        const key = addr + "||" + name;
        addressCountMap.set(key, (addressCountMap.get(key) || 0) + 1);
      });

      dataRows.forEach(row => {
        // í•„ìˆ˜ ìœ„ë„/ê²½ë„, ì£¼ì†Œ, í˜„ì¥ëª… ì²´í¬
        const lat = parseFloat(row[colIndex.ìœ„ë„]);
        const lng = parseFloat(row[colIndex.ê²½ë„]);
        const addr = row[colIndex.ì£¼ì†Œ]?.trim();
        const name = row[colIndex.í˜„ì¥ëª…]?.trim();

        if (
          isNaN(lat) ||
          isNaN(lng) ||
          !addr ||
          !name
        ) return;

        // íŒ€ì€ ê°•ë‚¨íŒ€/ê°•ë¶íŒ€ ì™¸ ë¬´ì‹œ
        const teamRaw = row[colIndex.íŒ€]?.trim() || "";
        const team =
          teamRaw === "ê°•ë‚¨íŒ€" || teamRaw === "ê°•ë¶íŒ€" ? teamRaw : "";

        // ë‚ ì§œ ì¡´ì¬ ì—¬ë¶€
        const hasDate = parseDateExistence(row[colIndex.ë‚ ì§œ]);

        // ìƒ‰ìƒ ê²°ì •
        const markerColor = getMarkerColor(team, hasDate);

        // ì¤‘ë³µ ì¹´ìš´íŠ¸
        const key = addr + "||" + name;
        const count = addressCountMap.get(key) || 1;

        // ë§ˆì»¤ ìƒì„±
        const marker = L.circleMarker([lat, lng], {
          color: markerColor,
          radius: 8,
          fillOpacity: 0.8
        }).addTo(map);

        // íŒì—… ë‚´ìš© ì¤€ë¹„
        const data = {
          í˜„ì¥ëª…: name,
          wë²ˆí˜¸: row[colIndex.wë²ˆí˜¸]?.trim() || "",
          ì£¼ì†Œ: addr,
          ì—°ë½ì²˜: row[colIndex.ì—°ë½ì²˜]?.trim() || "",
          íŠ¹ì´ì‚¬í•­: row[colIndex.íŠ¹ì´ì‚¬í•­]?.trim() || "",
          ê¸°ì¢…: row[colIndex.ê¸°ì¢…]?.trim() || "",
          Fan: row[colIndex.Fan]?.trim() || "",
          ë¹„ìƒí†µí™”: row[colIndex.ë¹„ìƒí†µí™”]?.trim() || "",
          ìœ íš¨ê¸°ê°„: row[colIndex.ìœ íš¨ê¸°ê°„]?.trim() || "",
          íŒ€: team,
          ë‚ ì§œì¡´ì¬: hasDate
        };

        // ë§ˆì»¤ ë¼ë²¨ (ì¤‘ë³µì´ë©´ ìˆ«ì í¬í•¨)
        const labelText = count > 1 ? `${name} (${count})` : name;

        marker.bindPopup(createPopupContent(data), { maxWidth: 300 });
        marker.bindTooltip(labelText, { permanent: true, direction: "top" });
      });
    } catch (e) {
      console.error(e);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  main();
</script>
</body>
</html>
