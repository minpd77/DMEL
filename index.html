<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Leaflet + TSV 마커 및 조건별 색상</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map { height: 600px; width: 100%; }
    .popup-content { font-size: 14px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([37.5665, 126.978], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    const tsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpveOpTjSLo3ZOFfCaoqJlknJXl0FyhmsAy7ICy-L_EsGun7Tf9uCqZbp97_yXYQwx-p_BlTpSouwn/pub?gid=381852124&single=true&output=tsv';

    function parseTSV(text) {
      return text.trim().split('\n').map(line => line.split('\t'));
    }

    // W열 숫자를 7자리 '0000-000' 형식으로 변환
    function formatW(value) {
      if (!value) return '';
      const num = value.toString().replace(/\D/g, ''); // 숫자만 추출
      if (num.length <= 3) return '000-' + num.padStart(3, '0');
      if (num.length === 7) return num.slice(0,4) + '-' + num.slice(4);
      // 7자리 아니면 그냥 리턴
      return value;
    }

    fetch(tsvUrl)
      .then(res => res.text())
      .then(text => {
        const rows = parseTSV(text);

        // 열 인덱스 (0부터)
        const COLS = {
          lat: 34,  // AI
          lng: 35,  // AJ
          af: 31,   // AF
          w: 22,    // W
          aa: 26,   // AA
          ab: 27,   // AB
          g: 6,     // G
          x: 23,    // X
          z: 25,    // Z
          ad: 29,   // AD
          s: 18,    // S
          k: 10     // K
        };

        const data = rows.slice(1); // 2행부터 처리

        data.forEach(row => {
          const lat = parseFloat(row[COLS.lat]);
          const lng = parseFloat(row[COLS.lng]);
          if (!lat || !lng) return;

          // 마커 색상 조건
          const team = row[COLS.s]?.trim();
          const dateVal = row[COLS.k]?.trim();
          let color = 'blue'; // 기본 파란색

          if (dateVal) {
            color = 'gray'; // 날짜가 있으면 회색 우선
          } else if (team === '강남팀') {
            color = 'green';
          } else if (team === '강북팀') {
            color = 'blue';
          }

          // 마커 아이콘 커스텀 (컬러 원형)
          const markerHtml = `<div style="
            background-color: ${color};
            width: 16px; height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px #555;
          "></div>`;

          const myIcon = L.divIcon({
            html: markerHtml,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10],
          });

          const marker = L.marker([lat, lng], { icon: myIcon }).addTo(map);

          // 팝업 내용
          const popupHtml = `
            <div class="popup-content">
              <b>현장명 (AF):</b> ${row[COLS.af] || ''} <br/>
              <b>W (7자리):</b> ${formatW(row[COLS.w])} <br/>
              <b>AA:</b> ${row[COLS.aa] || ''} <br/>
              <b>AB:</b> ${row[COLS.ab] || ''} <br/>
              <b>G:</b> ${row[COLS.g] || ''} <br/>
              <b>X:</b> ${row[COLS.x] || ''} <br/>
              <b>Z:</b> ${row[COLS.z] || ''} <br/>
              <b>AD:</b> ${row[COLS.ad] || ''}
            </div>
          `;

          marker.bindPopup(popupHtml);
        });
      })
      .catch(e => alert('TSV 불러오기 실패: ' + e));
  </script>
</body>
</html>
