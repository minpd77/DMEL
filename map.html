<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëŒ€ëª…ì—˜ë¦¬ë² ì´í„° ê³ ì¥ì‹ ê³  ì§€ë„ (ìœ„ë„ê²½ë„ ê¸°ë°˜)</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
    #fault-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .fault-item {
      padding: 5px;
      border-bottom: 1px solid #ccc;
    }
    .resolved {
      color: gray;
    }
    .unresolved {
      color: black;
      font-weight: bold;
    }
    .siren {
      color: red;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>ëŒ€ëª…ì—˜ë¦¬ë² ì´í„° ê³ ì¥ì‹ ê³  ì§€ë„</h1>
  <div id="map"></div>
  <div id="fault-list"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    // ì§€ë„ ì´ˆê¸°í™” (ì„œìš¸ ì‹œì²­ ê¸°ì¤€)
    const map = L.map('map').setView([37.5665, 126.978], 12);

    // OSM íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // CSV URL
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkPXudgO_znrjg8-ZyoSmMb5dhrISbANstWt3xNanbbTNCNRhDwAQgxhrECxwN8R2QSV8lTgln6_9P/pub?gid=1682703072&single=true&output=csv';

    const markers = {};
    const markerGroup = L.layerGroup().addTo(map);

    // ê³ ì¥ ë¦¬ìŠ¤íŠ¸ DOM
    const faultListDiv = document.getElementById('fault-list');

    // ê³ ì¥ ìƒíƒœ ì˜ˆì‹œ (ë¯¸í•´ê²°: unresolved, í•´ê²°: resolved)
    // ì‹¤ì œ ê°’ì— ë”°ë¼ ë§ì¶°ì„œ ë°”ê¾¸ì„¸ìš”
    function isResolved(row) {
      // ì˜ˆ: í•´ê²° ì—¬ë¶€ íŒë‹¨ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ falseë¡œ ê°„ì£¼ (ëª¨ë‘ ë¯¸í•´ê²°)
      return false;
    }

    function createMarker(row, idx) {
      const latLngStr = row['T'];
      if (!latLngStr) return null;

      const parts = latLngStr.split(',');
      if (parts.length !== 2) return null;

      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (isNaN(lat) || isNaN(lng)) return null;

      const marker = L.marker([lat, lng]);

      const popupContent = `
        <b>í˜„ì¥ëª…:</b> ${row['í˜„ì¥ëª…'] || 'ì •ë³´ì—†ìŒ'}<br/>
        <b>ì£¼ì†Œ:</b> ${row['G'] || 'ì •ë³´ì—†ìŒ'}<br/>
        <b>ì‹ ê³ ë‚´ìš©:</b> ${row['G'] || 'ì •ë³´ì—†ìŒ'}<br/>
        <button onclick="resolveFault(${idx})">í•´ê²° ì™„ë£Œ</button>
      `;
      marker.bindPopup(popupContent);
      marker.addTo(markerGroup);
      return marker;
    }

    // ë§ˆì»¤ì™€ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ë¥¼ ìœ„í•œ ë°°ì—´
    let faultData = [];
    let faultMarkers = [];

    // í•´ê²° ì™„ë£Œ ì²˜ë¦¬ (ì„ì‹œ - ì‹¤ì œ ì„œë²„ ì—°ë™ í•„ìš”)
    window.resolveFault = function(idx) {
      alert('í•´ê²° ì²˜ë¦¬ë¨ (ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”)');
      // ì˜ˆ) markerGroup.removeLayer(faultMarkers[idx]);
      // ê·¸ë¦¬ê³  ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë“± ì¶”ê°€ ì‘ì—… í•„ìš”
    };

    function renderFaultList(data) {
      faultListDiv.innerHTML = '';
      data.forEach((row, idx) => {
        const resolved = isResolved(row);
        const div = document.createElement('div');
        div.className = 'fault-item ' + (resolved ? 'resolved' : 'unresolved');
        div.innerHTML = resolved
          ? `${row['í˜„ì¥ëª…'] || 'ì •ë³´ì—†ìŒ'} - í•´ê²°ì: ${row['í•´ê²°ì'] || ''}`
          : `<span class="siren">ğŸš¨</span>${row['í˜„ì¥ëª…'] || 'ì •ë³´ì—†ìŒ'}`;
        div.onclick = () => {
          if (faultMarkers[idx]) {
            map.setView(faultMarkers[idx].getLatLng(), 16);
            faultMarkers[idx].openPopup();
          }
        };
        faultListDiv.appendChild(div);
      });
    }

    // CSV ë¡œë“œ í›„ ë§ˆì»¤ ìƒì„±, ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: function(results) {
        faultData = results.data;
        faultMarkers = [];

        markerGroup.clearLayers();

        faultData.forEach((row, idx) => {
          const marker = createMarker(row, idx);
          if (marker) faultMarkers.push(marker);
        });

        renderFaultList(faultData);
      },
      error: function(err) {
        console.error('CSV ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    });
  </script>
</body>
</html>
